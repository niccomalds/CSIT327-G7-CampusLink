{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CampusLink â€“ My Applications</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="{% static 'Myapp/my_applications_v2.css' %}?v=1.2">
</head>
<body>
  <header class="header">
    <div class="logo">
      <i class="fa-solid fa-graduation-cap"></i>
      <span>CampusLink</span>
    </div>
    <nav>
      <a href="{% url 'student_dashboard' %}">Home</a>
      <a href="{% url 'my_applications' %}" class="active">My Applications</a>
      <a href="{% url 'profile' %}">Profile</a>
      <a href="#">Notifications</a>
    </nav>
    <div class="search-profile">
      <input type="text" class="top-search" placeholder="Search applications...">

      <!-- PROFILE DROPDOWN -->
      <div class="profile-dropdown">
        <img src="{{ user.profile.profile_picture.url|default:'/static/Myapp/default-avatar.png' }}"
             alt="Profile" class="avatar" id="profileAvatar">

        <div class="dropdown-menu" id="profileMenu">
          <div class="dropdown-header">Student</div>
          <a href="{% url 'profile' %}"><i class="fa-solid fa-user"></i> Profile</a>
          <a href="#"><i class="fa-solid fa-gear"></i> Settings</a>
          <a href="{% url 'logout' %}"><i class="fa-solid fa-right-from-bracket"></i> Log out</a>
        </div>
      </div>
    </div>
  </header>

  <main>
    <!-- Page Header -->
    <div class="dashboard-title">
      <h1>My <span class="highlight">Applications</span></h1>
      <p>Track your application progress and stay updated on opportunities.</p>
    </div>

    <!-- Statistics Cards -->
    <section class="stats-row">
      <div class="stat-card">
        <span class="stat-num" id="totalApplications">5</span>
        <span class="stat-label">Total</span>
      </div>
      <div class="stat-card">
        <span class="stat-num" id="submittedApplications">2</span>
        <span class="stat-label">Submitted</span>
      </div>
      <div class="stat-card">
        <span class="stat-num" id="reviewApplications">1</span>
        <span class="stat-label">Review</span>
      </div>
      <div class="stat-card">
        <span class="stat-num" id="acceptedApplications">1</span>
        <span class="stat-label">Accepted</span>
      </div>
      <div class="stat-card">
        <span class="stat-num" id="rejectedApplications">1</span>
        <span class="stat-label">Rejected</span>
      </div>
      <div class="stat-card">
        <span class="stat-num" id="withdrawnApplications">0</span>
        <span class="stat-label">Withdrawn</span>
      </div>
    </section>

    <!-- Search and Filter -->
    <section class="search-filter-row">
      <div class="search-box">
        <i class="fa-solid fa-magnifying-glass"></i>
        <input type="text" placeholder="Search applications..." id="applicationSearch">
      </div>
      <select class="filter-dropdown" id="statusFilter">
        <option>All Status</option>
        <option>Submitted</option>
        <option>Under Review</option>
        <option>Accepted</option>
        <option>Rejected</option>
        <option>Withdrawn</option>
      </select>
    </section>

    <!-- Applications List -->
    <section class="applications-container">
      {% if applications %}
        {% for application in applications %}
        <div class="application-card" data-application-id="{{ application.id }}" data-status="{{ application.status }}">
          <div class="app-header">
            <div class="app-title-section">
              <h3>{{ application.posting.title }}</h3>
              <span class="app-org">{{ application.posting.organization.username }}</span>
            </div>
            <div class="app-actions">
              <span class="status-badge status-{{ application.status }}">
                {% if application.status == 'submitted' %}
                  <i class="fa-regular fa-clock"></i>
                {% elif application.status == 'under_review' %}
                  <i class="fa-regular fa-eye"></i>
                {% elif application.status == 'accepted' %}
                  <i class="fa-solid fa-check"></i>
                {% elif application.status == 'rejected' %}
                  <i class="fa-solid fa-xmark"></i>
                {% elif application.status == 'withdrawn' %}
                  <i class="fa-solid fa-ban"></i>
                {% endif %}
                {{ application.get_status_display }}
              </span>
              <div class="action-buttons">
                <button class="view-details-btn" onclick="openApplicationModal({{ application.id }})">
                  <i class="fa-regular fa-file-lines"></i>
                  View Details
                </button>
                {% if application.status == 'submitted' or application.status == 'under_review' %}
                <button class="withdraw-btn" onclick="showWithdrawConfirmation({{ application.id }})">
                  <i class="fa-solid fa-xmark"></i>
                  Withdraw
                </button>
                {% endif %}
              </div>
            </div>
          </div>
          <div class="app-desc">{{ application.posting.description }}</div>
          <div class="app-meta">
            <span class="app-date">
              <i class="fa-solid fa-calendar-check"></i>
              Applied: {{ application.created_at|date:"M d, Y" }}
            </span>
            <span class="app-deadline">
              <i class="fa-solid fa-clock"></i>
              Deadline: {{ application.posting.deadline }}
            </span>
          </div>
        </div>
        {% endfor %}
      {% else %}
        <!-- Sample applications (fallback) -->
        <div class="application-card" data-application-id="1" data-status="submitted">
          <div class="app-header">
            <div class="app-title-section">
              <h3>Software Engineering Intern</h3>
              <span class="app-org">Tech Innovations Lab</span>
            </div>
            <div class="app-actions">
              <span class="status-badge status-submitted">
                <i class="fa-regular fa-clock"></i> Submitted
              </span>
              <div class="action-buttons">
                <button class="view-details-btn" onclick="openApplicationModal(1)">
                  <i class="fa-regular fa-file-lines"></i> View Details
                </button>
                <button class="withdraw-btn" onclick="showWithdrawConfirmation(1)">
                  <i class="fa-solid fa-xmark"></i> Withdraw
                </button>
              </div>
            </div>
          </div>
          <div class="app-desc">Join our dynamic team as a Software Engineering Intern. Work on cutting-edge projects and gain real-world experience in full-stack development.</div>
          <div class="app-meta">
            <span class="app-date">
              <i class="fa-solid fa-calendar-check"></i> Applied: Jan 15, 2024
            </span>
            <span class="app-deadline">
              <i class="fa-solid fa-clock"></i> Deadline: Feb 15, 2024
            </span>
          </div>
        </div>

        <div class="application-card" data-application-id="2" data-status="under_review">
          <div class="app-header">
            <div class="app-title-section">
              <h3>Research Assistant - AI</h3>
              <span class="app-org">Computer Science Department</span>
            </div>
            <div class="app-actions">
              <span class="status-badge status-under_review">
                <i class="fa-regular fa-eye"></i> Under Review
              </span>
              <div class="action-buttons">
                <button class="view-details-btn" onclick="openApplicationModal(2)">
                  <i class="fa-regular fa-file-lines"></i> View Details
                </button>
                <button class="withdraw-btn" onclick="showWithdrawConfirmation(2)">
                  <i class="fa-solid fa-xmark"></i> Withdraw
                </button>
              </div>
            </div>
          </div>
          <div class="app-desc">Assist faculty members in cutting-edge AI research projects. Perfect for students interested in machine learning and data science.</div>
          <div class="app-meta">
            <span class="app-date">
              <i class="fa-solid fa-calendar-check"></i> Applied: Jan 10, 2024
            </span>
            <span class="app-deadline">
              <i class="fa-solid fa-clock"></i> Deadline: Feb 20, 2024
            </span>
          </div>
        </div>

        <div class="application-card" data-application-id="3" data-status="accepted">
          <div class="app-header">
            <div class="app-title-section">
              <h3>Marketing Coordinator</h3>
              <span class="app-org">Student Union</span>
            </div>
            <div class="app-actions">
              <span class="status-badge status-accepted">
                <i class="fa-solid fa-check"></i> Accepted
              </span>
              <div class="action-buttons">
                <button class="view-details-btn" onclick="openApplicationModal(3)">
                  <i class="fa-regular fa-file-lines"></i> View Details
                </button>
              </div>
            </div>
          </div>
          <div class="app-desc">Coordinate marketing campaigns and social media strategies for campus events. Great opportunity for communications and business majors.</div>
          <div class="app-meta">
            <span class="app-date">
              <i class="fa-solid fa-calendar-check"></i> Applied: Jan 8, 2024
            </span>
            <span class="app-deadline">
              <i class="fa-solid fa-clock"></i> Deadline: Feb 10, 2024
            </span>
          </div>
        </div>
      {% endif %}
    </section>
  </main>

  <!-- Withdrawal Confirmation Modal -->
  <div id="withdrawModal" class="modal">
    <div class="modal-content withdraw-confirmation">
      <div class="modal-header">
        <h2>Withdraw Application</h2>
        <span class="close-modal" onclick="closeWithdrawModal()">&times;</span>
      </div>
      <div class="modal-body">
        <div class="warning-icon">
          <i class="fa-solid fa-exclamation-triangle"></i>
        </div>
        <h3>Are you sure you want to withdraw this application?</h3>
        <p>This action cannot be undone. You will need to re-apply if you change your mind.</p>
        <div class="application-preview">
          <strong id="withdrawJobTitle"></strong>
          <span id="withdrawOrganization"></span>
        </div>
      </div>
      <div class="modal-footer">
        <button class="cancel-btn" onclick="closeWithdrawModal()">Cancel</button>
        <button class="confirm-withdraw-btn" onclick="confirmWithdrawal()">Yes, Withdraw Application</button>
      </div>
    </div>
  </div>

  <!-- Application Details Modal -->
  <div id="applicationModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Application Details</h2>
        <span class="close-modal" onclick="closeApplicationModal()">&times;</span>
      </div>
      <div class="modal-body">
        <div class="application-info">
          <div class="info-section">
            <h3 id="modalJobTitle"></h3>
            <p id="modalOrganization" class="org-name"></p>
            <div class="status-display">
              <span id="modalStatus" class="status-badge status-submitted"></span>
            </div>
          </div>
          <div class="details-grid">
            <div class="detail-item">
              <label><i class="fa-solid fa-calendar-check"></i> Applied Date</label>
              <span id="modalAppliedDate"></span>
            </div>
            <div class="detail-item">
              <label><i class="fa-solid fa-clock"></i> Deadline</label>
              <span id="modalDeadline"></span>
            </div>
            <div class="detail-item">
              <label><i class="fa-solid fa-map-marker-alt"></i> Work Mode</label>
              <span id="modalWorkMode"></span>
            </div>
            <div class="detail-item">
              <label><i class="fa-solid fa-briefcase"></i> Position Type</label>
              <span id="modalPositionType"></span>
            </div>
          </div>
          <div class="description-section">
            <h4>Job Description</h4>
            <p id="modalDescription"></p>
          </div>
          <div class="submitted-materials">
            <h4>Submitted Materials</h4>
            <div class="resume-section">
              <div class="section-header">
                <h5><i class="fa-solid fa-file-pdf"></i> Resume</h5>
                <button class="download-btn" onclick="downloadResume()">
                  <i class="fa-solid fa-download"></i> Download
                </button>
              </div>
              <div class="file-preview">
                <div class="pdf-preview">
                  <i class="fa-solid fa-file-pdf pdf-icon"></i>
                  <div class="pdf-info">
                    <span class="file-name" id="resumeFileName"></span>
                    <span class="file-size">2.4 MB</span>
                  </div>
                </div>
              </div>
            </div>
            <div class="notes-section">
              <div class="section-header">
                <h5><i class="fa-solid fa-note-sticky"></i> Cover Letter & Notes</h5>
              </div>
              <div class="notes-content">
                <p id="modalNotes"></p>
              </div>
            </div>
          </div>
          <div class="application-timeline">
            <h4>Application Timeline</h4>
            <div class="timeline" id="timelineContent">
              <!-- Timeline items can be dynamically populated -->
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="close-btn" onclick="closeApplicationModal()">Close</button>
      </div>
    </div>
  </div>

  <!-- Toast Notification -->
  <div id="toast" class="toast"></div>

  <script>
    /* ===== Profile Dropdown ===== */
    const avatar = document.getElementById('profileAvatar');
    const menu = document.getElementById('profileMenu');
    
    if (avatar && menu) {
      avatar.addEventListener('click', () => {
        menu.parentElement.classList.toggle('show');
      });
      window.addEventListener('click', (e) => {
        if (!avatar.contains(e.target) && !menu.contains(e.target)) {
          menu.parentElement.classList.remove('show');
        }
      });
    }

    /* ===== Search & Filter ===== */
    const searchInput = document.getElementById('applicationSearch');
    searchInput?.addEventListener('input', function() {
      const term = this.value.toLowerCase();
      document.querySelectorAll('.application-card').forEach(card => {
        card.style.display = card.textContent.toLowerCase().includes(term) ? 'block' : 'none';
      });
    });

    const statusFilter = document.getElementById('statusFilter');
    statusFilter?.addEventListener('change', function() {
      const selected = this.value.toLowerCase().replace(' ', '_');
      document.querySelectorAll('.application-card').forEach(card => {
        const status = card.dataset.status;
        card.style.display = selected === 'all_status' ? 'block' : (status === selected ? 'block' : 'none');
      });
    });

    /* ===== Withdrawal ===== */
    let currentWithdrawId = null;
    function showWithdrawConfirmation(id) {
      currentWithdrawId = id;
      const card = document.querySelector(`[data-application-id="${id}"]`);
      document.getElementById('withdrawJobTitle').textContent = card.querySelector('h3').textContent;
      document.getElementById('withdrawOrganization').textContent = card.querySelector('.app-org').textContent;
      document.getElementById('withdrawModal').style.display = 'block';
      document.body.style.overflow = 'hidden';
    }
    function closeWithdrawModal() {
      document.getElementById('withdrawModal').style.display = 'none';
      document.body.style.overflow = 'auto';
      currentWithdrawId = null;
    }
    function confirmWithdrawal() {
      if (!currentWithdrawId) return;
      simulateWithdrawal(currentWithdrawId);
      closeWithdrawModal();
      showToast('Application withdrawn successfully!');
    }
    function simulateWithdrawal(id) {
      const card = document.querySelector(`[data-application-id="${id}"]`);
      const statusBadge = card.querySelector('.status-badge');
      const withdrawBtn = card.querySelector('.withdraw-btn');
      card.dataset.status = 'withdrawn';
      statusBadge.className = 'status-badge status-withdrawn';
      statusBadge.innerHTML = '<i class="fa-solid fa-ban"></i> Withdrawn';
      withdrawBtn?.remove();
      updateStatistics();
    }

    /* ===== Update Statistics ===== */
    function updateStatistics() {
      const counts = { submitted: 0, under_review: 0, accepted: 0, rejected: 0, withdrawn: 0 };
      document.querySelectorAll('.application-card').forEach(card => counts[card.dataset.status]++);
      const total = Object.values(counts).reduce((a,b)=>a+b,0);
      document.getElementById('totalApplications').textContent = total;
      document.getElementById('submittedApplications').textContent = counts.submitted;
      document.getElementById('reviewApplications').textContent = counts.under_review;
      document.getElementById('acceptedApplications').textContent = counts.accepted;
      document.getElementById('rejectedApplications').textContent = counts.rejected;
      document.getElementById('withdrawnApplications').textContent = counts.withdrawn;
    }

    /* ===== Application Details Modal ===== */
    const modal = document.getElementById('applicationModal');
    function openApplicationModal(id) {
      const data = getSampleApplicationData(id);
      populateModalData(data);
      modal.style.display = 'block';
      document.body.style.overflow = 'hidden';
    }
    function closeApplicationModal() {
      modal.style.display = 'none';
      document.body.style.overflow = 'auto';
    }
    function populateModalData(data) {
      document.getElementById('modalJobTitle').textContent = data.jobTitle;
      document.getElementById('modalOrganization').textContent = data.organization;
      document.getElementById('modalAppliedDate').textContent = data.appliedDate;
      document.getElementById('modalDeadline').textContent = data.deadline;
      document.getElementById('modalWorkMode').textContent = data.workMode;
      document.getElementById('modalPositionType').textContent = data.positionType;
      document.getElementById('modalDescription').textContent = data.description;
      document.getElementById('resumeFileName').textContent = data.resumeFile;
      document.getElementById('modalNotes').textContent = data.notes;

      const badge = document.getElementById('modalStatus');
      badge.className = `status-badge status-${data.status}`;
      let icon = '', text = '';
      switch(data.status){
        case 'submitted': icon='fa-regular fa-clock'; text='Submitted'; break;
        case 'under_review': icon='fa-regular fa-eye'; text='Under Review'; break;
        case 'accepted': icon='fa-solid fa-check'; text='Accepted'; break;
        case 'rejected': icon='fa-solid fa-xmark'; text='Rejected'; break;
        case 'withdrawn': icon='fa-solid fa-ban'; text='Withdrawn'; break;
      }
      badge.innerHTML = `<i class="${icon}"></i> ${text}`;
    }
    function downloadResume() {
      const fileName = document.getElementById('resumeFileName').textContent;
      showToast(`Downloading resume: ${fileName}`);
    }
    function getSampleApplicationData(id) {
      const sampleData = {
        1:{jobTitle:"Software Engineering Intern",organization:"Tech Innovations Lab",status:"submitted",appliedDate:"Jan 15, 2024",deadline:"Feb 15, 2024",workMode:"Remote",positionType:"Internship",description:"Full-stack internship.",resumeFile:"john_doe_resume.pdf",notes:"Excited to join the team."},
        2:{jobTitle:"Research Assistant - AI",organization:"Computer Science Department",status:"under_review",appliedDate:"Jan 10, 2024",deadline:"Feb 20, 2024",workMode:"On Campus",positionType:"Research",description:"Assist faculty in AI research.",resumeFile:"research_assistant_resume.pdf",notes:"Interested in ML research."},
        3:{jobTitle:"Marketing Coordinator",organization:"Student Union",status:"accepted",appliedDate:"Jan 8, 2024",deadline:"Feb 10, 2024",workMode:"On Campus",positionType:"Part-time",description:"Coordinate marketing activities.",resumeFile:"marketing_coordinator_resume.pdf",notes:"Experience in social media."},
        4:{jobTitle:"Web Developer",organization:"Campus Startups Inc.",status:"rejected",appliedDate:"Jan 5, 2024",deadline:"Jan 30, 2024",workMode:"Hybrid",positionType:"Freelance",description:"Develop web apps.",resumeFile:"web_developer_resume.pdf",notes:"Portfolio includes React/Node.js."},
        5:{jobTitle:"Data Analyst Intern",organization:"Business Analytics Club",status:"submitted",appliedDate:"Jan 12, 2024",deadline:"Feb 25, 2024",workMode:"Remote",positionType:"Internship",description:"Analyze business data.",resumeFile:"data_analyst_resume.pdf",notes:"Strong SQL skills."}
      };
      return sampleData[id] || sampleData[1];
    }

    /* ===== Toast Notification ===== */
    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = 'toast show';
      setTimeout(()=>{ toast.className='toast'; },3000);
    }
  </script>
</body>
</html>