{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CampusLink â€“ My Applications</title>
    <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="{% static 'Myapp/applications_main.css' %}?v={% now 'U' %}">
  <!-- Include the error message component CSS -->
  <link rel="stylesheet" href="{% static 'Myapp/error_message.css' %}">
</head>
<body>
  <!-- Alert container for global error messages -->
  <div class="alert-container"></div>
  
 <header class="sticky top-0 z-40 bg-white">
    <!-- full-width header background; inner container centers content -->
    <div class="w-full left-0 right-0 shadow-[0_4px_12px_rgba(0,0,0,0.08)]">
        <div class="max-w-[1400px] mx-auto w-full flex items-center justify-between px-12 py-4 rounded-b-[16px] ">

            <div class="logo flex items-center gap-3 text-[#00c6ff]">
                <i class="fa-solid fa-graduation-cap text-2xl"></i>
                <span class="text-2xl font-extrabold">CampusLink</span>
            </div>

            <nav class="flex items-center">
                <a href="{% url 'student_dashboard' %}" class="text-gray-600 font-medium text-base pb-1 border-b-2 border-transparent hover:text-[#00c6ff] hover:border-[#00c6ff] ">Home</a>
                <a href="{% url 'my_applications' %}"   class="text-gray-600 font-medium text-base pb-1 border-b-2 border-transparent hover:text-[#00c6ff] hover:border-[#00c6ff] active">My Applications</a>
                <a href="{% url 'profile' %}"           class="text-gray-600 font-medium text-base pb-1 border-b-2 border-transparent">Profile</a>
            </nav>

            <div class="search-profile flex items-center gap-4">

                <!-- ðŸ”” NOTIFICATION BELL -->
                <div class="notification-wrapper relative">
                    <a href="{% url 'student_notification' %}" id="notifBell" class="notif-bell text-gray-600 hover:text-[#00c6ff] relative">
                        <i class="fa-solid fa-bell"></i>
                        {% if unread_count > 0 %}
                        <span class="notif-badge">{{ unread_count }}</span>
                        {% endif %}
                    </a>
                </div>

                <!-- PROFILE DROPDOWN -->
                <div class="profile-dropdown">
                    <img src="{% if user.profile.profile_picture %}{{ user.profile.profile_picture.url }}{% else %}{% static 'Myapp/default-avatar.png' %}{% endif %}"
                             alt="Profile"
                             class="avatar"
                             id="profileAvatar">

                    <div class="dropdown-menu" id="profileMenu">
                        <div class="dropdown-header">Student</div>

                        <a href="{% url 'profile' %}">
                            <i class="fa-solid fa-user"></i> Profile
                        </a>

                        <a href="{% url 'logout' %}">
                            <i class="fa-solid fa-right-from-bracket"></i> Log out
                        </a>
                    </div>
                </div>

            </div>

        </div>
    </div>
</header>



  <main class="applications-main">
    <!-- Page Header -->
    <div class="dashboard-title">
      <h1>My <span class="highlight">Applications</span></h1>
      <p>Track your application progress and stay updated on opportunities.</p>
    </div>

    <!-- Statistics Cards -->
    <section class="stats-row">
      <div class="stat-card">
        <span class="stat-num" id="submittedApplications">{{ submitted_count }}</span>
        <span class="stat-label">Submitted</span>
      </div>
      <div class="stat-card">
        <span class="stat-num" id="acceptedApplications">{{ accepted_count }}</span>
        <span class="stat-label">Accepted</span>
      </div>
      <div class="stat-card">
        <span class="stat-num" id="rejectedApplications">{{ rejected_count }}</span>
        <span class="stat-label">Rejected</span>
      </div>
      <div class="stat-card">
        <span class="stat-num" id="withdrawnApplications">{{ withdrawn_count }}</span>
        <span class="stat-label">Withdrawn</span>
      </div>
    </section>

    <!-- Search and Filter -->
    <section class="search-filter-row">
      <div class="search-box">
        <i class="fa-solid fa-magnifying-glass"></i>
        <input type="text" placeholder="Search applications..." id="applicationSearch">
      </div>
      <select class="filter-dropdown" id="statusFilter">
        <option>All Status</option>
        <option>Submitted</option>
        <option>Accepted</option>
        <option>Rejected</option>
        <option>Withdrawn</option>
      </select>
    </section>

    <!-- Applications List -->
    <section class="applications-container">
      {% if applications %}
        {% for application in applications %}
        <div class="application-card" data-application-id="{{ application.id }}" 
             data-status="{{ application.status }}" 
             data-note="{{ application.note|escape }}"
             data-opportunity-type="{{ application.posting.get_opportunity_type_display|escape }}"
             data-tags="{% for tag in application.posting.tags_list %}{{ tag|escape }}{% if not forloop.last %},{% endif %}{% endfor %}">
          <div class="app-header">
            <div class="app-title-section">
              <h3>{{ application.posting.title }}</h3>
              <span class="app-org">{{ application.posting.organization.profile.org_name|default:application.posting.organization.username }}</span>
            </div>
            <div class="app-actions">
              <span class="status-badge status-{{ application.status }}">
                {% if application.status == 'submitted' %}
                  <i class="fa-regular fa-clock"></i>
                {% elif application.status == 'under_review' %}
                  <i class="fa-regular fa-eye"></i>
                {% elif application.status == 'accepted' %}
                  <i class="fa-solid fa-check"></i>
                {% elif application.status == 'rejected' %}
                  <i class="fa-solid fa-xmark"></i>
                {% elif application.status == 'withdrawn' %}
                  <i class="fa-solid fa-ban"></i>
                {% endif %}
                {{ application.get_status_display }}
              </span>
              <div class="action-buttons">
                <button class="view-details-btn" onclick="openApplicationModal({{ application.id }})">
                  <i class="fa-regular fa-file-lines"></i>
                  View Details
                </button>
                {% if application.status == 'submitted' or application.status == 'under_review' %}
                <button class="withdraw-btn" onclick="showWithdrawConfirmation({{ application.id }})">
                  <i class="fa-solid fa-xmark"></i>
                  Withdraw
                </button>
                {% endif %}
              </div>
            </div>
          </div>
          <div class="app-desc">{{ application.posting.description|truncatewords:30 }}</div>
          <div class="app-meta">
            <span class="app-date">
              <i class="fa-solid fa-calendar-check"></i>
              Applied: {{ application.created_at|date:"M d, Y" }}
            </span>
            <span class="app-deadline">
              <i class="fa-solid fa-clock"></i>
              Deadline: {{ application.posting.deadline|date:"M d, Y" }}
            </span>
          </div>
        </div>
        {% endfor %}
      {% else %}
        <div class="no-applications-message">
          <i class="fa-solid fa-inbox"></i>
          <h3>No Applications Yet</h3>
          <p>You haven't applied to any opportunities yet. Visit the <a href="{% url 'student_dashboard' %}">Student Dashboard</a> to explore and apply for opportunities.</p>
        </div>
      {% endif %}
    </section>
  </main>

  <!-- Withdrawal Confirmation Modal -->
  <div id="withdrawModal" class="modal">
    <div class="modal-content withdraw-confirmation">
      <div class="modal-header">
        <h2>Withdraw Application</h2>
        <span class="close-modal" onclick="closeWithdrawModal()">&times;</span>
      </div>
      <div class="modal-body">
        <div class="warning-icon">
          <i class="fa-solid fa-exclamation-triangle"></i>
        </div>
        <h3>Are you sure you want to withdraw this application?</h3>
        <p>This action cannot be undone. You will need to re-apply if you change your mind.</p>
        <div class="application-preview">
          <strong id="withdrawJobTitle"></strong>
          <span id="withdrawOrganization"></span>
        </div>
      </div>
      <div class="modal-footer">
        <button class="cancel-btn" onclick="closeWithdrawModal()">Cancel</button>
        <button class="confirm-withdraw-btn" onclick="confirmWithdrawal()">Yes, Withdraw Application</button>
      </div>
    </div>
  </div>

  <!-- Application Details Modal -->
  <div id="applicationModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Application Details</h2>
        <span class="close-modal" onclick="closeApplicationModal()">&times;</span>
      </div>
      <div class="modal-body">
        <div class="application-info">
          <div class="info-section">
            <h3 id="modalJobTitle"></h3>
            <p id="modalOrganization" class="org-name"></p>
            <div class="status-display">
              <span id="modalStatus" class="status-badge status-submitted"></span>
            </div>
          </div>
          <div class="details-grid">
            <div class="detail-item">
              <label><i class="fa-solid fa-calendar-check"></i> Applied Date</label>
              <span id="modalAppliedDate"></span>
            </div>
            <div class="detail-item">
              <label><i class="fa-solid fa-clock"></i> Deadline</label>
              <span id="modalDeadline"></span>
            </div>
            <div class="detail-item">
              <label><i class="fa-solid fa-briefcase"></i> Position Type</label>
              <span id="modalPositionType"></span>
            </div>
          </div>
          <div class="description-section">
            <h4>Job Description</h4>
            <p id="modalDescription"></p>
          </div>
          <div class="tags-section">
            <h4>Tags</h4>
            <div class="tags-container" id="modalTags">
              <!-- Tags will be populated here -->
            </div>
          </div>
          <div class="submitted-materials">
            <h4>Submitted Materials</h4>
            <div class="resume-section">
              <div class="section-header">
                <h5><i class="fa-solid fa-file-pdf"></i> Resume</h5>
                <button class="download-btn" onclick="downloadResume()">
                  <i class="fa-solid fa-download"></i> Download
                </button>
              </div>
              <div class="file-preview">
                <div class="pdf-preview">
                  <i class="fa-solid fa-file-pdf pdf-icon"></i>
                  <div class="pdf-info">
                    <span class="file-name" id="resumeFileName"></span>
                    <span class="file-size">2.4 MB</span>
                  </div>
                </div>
              </div>
            </div>
            <div class="notes-section">
              <div class="section-header">
                <h5><i class="fa-solid fa-note-sticky"></i> Cover Letter & Notes</h5>
              </div>
              <div class="notes-content">
                <p id="modalNotes"></p>
              </div>
            </div>
          </div>
          <div class="application-timeline">
            <h4>Application Timeline</h4>
            <div class="timeline" id="timelineContent">
              <!-- Timeline items can be dynamically populated -->
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="close-btn" onclick="closeApplicationModal()">Close</button>
      </div>
    </div>
  </div>

  <!-- Toast Notification -->
  <div id="toast" class="toast"></div>

  <script>
    /* ===== Profile Dropdown ===== */
    const avatar = document.getElementById('profileAvatar');
    const menu = document.getElementById('profileMenu');
    
    if (avatar && menu) {
      avatar.addEventListener('click', () => {
        menu.parentElement.classList.toggle('show');
      });
      window.addEventListener('click', (e) => {
        if (!avatar.contains(e.target) && !menu.contains(e.target)) {
          menu.parentElement.classList.remove('show');
        }
      });
    }

    /* ===== Search & Filter ===== */
    const searchInput = document.getElementById('applicationSearch');
    searchInput?.addEventListener('input', function() {
      const term = this.value.toLowerCase();
      document.querySelectorAll('.application-card').forEach(card => {
        card.style.display = card.textContent.toLowerCase().includes(term) ? 'block' : 'none';
      });
    });

    const statusFilter = document.getElementById('statusFilter');
    statusFilter?.addEventListener('change', function() {
      const selected = this.value.toLowerCase().replace(' ', '_');
      document.querySelectorAll('.application-card').forEach(card => {
        const status = card.dataset.status;
        card.style.display = selected === 'all_status' ? 'block' : (status === selected ? 'block' : 'none');
      });
    });

    /* ===== Withdrawal ===== */
    let currentWithdrawId = null;
    function showWithdrawConfirmation(id) {
      currentWithdrawId = id;
      const card = document.querySelector(`[data-application-id="${id}"]`);
      document.getElementById('withdrawJobTitle').textContent = card.querySelector('h3').textContent;
      document.getElementById('withdrawOrganization').textContent = card.querySelector('.app-org').textContent;
      document.getElementById('withdrawModal').style.display = 'block';
      document.body.style.overflow = 'hidden';
    }
    function closeWithdrawModal() {
      document.getElementById('withdrawModal').style.display = 'none';
      document.body.style.overflow = 'auto';
      currentWithdrawId = null;
    }
    function confirmWithdrawal() {
      if (!currentWithdrawId) return;
      
      // Show processing message
      const processingMsg = showInfoMessage('Processing', 'Withdrawing application...', false);
      
      // Simulate API call
      setTimeout(function() {
        // Dismiss processing message
        processingMsg.querySelector('.alert-close').click();
        
        // Simulate withdrawal success or failure
        if (Math.random() > 0.2) {
          simulateWithdrawal(currentWithdrawId);
          closeWithdrawModal();
          showSuccessMessage('Success', 'Application withdrawn successfully!');
          showToast('Application withdrawn successfully!');
        } else {
          showErrorMessage('Error', 'Failed to withdraw application. Please try again.');
        }
      }, 1500);
    }
    function simulateWithdrawal(id) {
      const card = document.querySelector(`[data-application-id="${id}"]`);
      const statusBadge = card.querySelector('.status-badge');
      const withdrawBtn = card.querySelector('.withdraw-btn');
      card.dataset.status = 'withdrawn';
      statusBadge.className = 'status-badge status-withdrawn';
      statusBadge.innerHTML = '<i class="fa-solid fa-ban"></i> Withdrawn';
      withdrawBtn?.remove();
      updateStatistics();
    }

    /* ===== Update Statistics ===== */
    function updateStatistics() {
      const counts = { submitted: 0, under_review: 0, accepted: 0, rejected: 0, withdrawn: 0 };
      document.querySelectorAll('.application-card').forEach(card => counts[card.dataset.status]++);
      document.getElementById('submittedApplications').textContent = counts.submitted;
      document.getElementById('acceptedApplications').textContent = counts.accepted;
      document.getElementById('rejectedApplications').textContent = counts.rejected;
      document.getElementById('withdrawnApplications').textContent = counts.withdrawn;
    }

    /* ===== Application Details Modal ===== */
    const modal = document.getElementById('applicationModal');
    function openApplicationModal(id) {
      const card = document.querySelector(`[data-application-id="${id}"]`);
      if (card) {
        // Extract data from the card
        const jobTitle = card.querySelector('h3').textContent;
        const organization = card.querySelector('.app-org').textContent;
        const statusElement = card.querySelector('.status-badge');
        const statusClass = statusElement.className;
        const statusText = statusElement.textContent.trim();
        const appliedDate = card.querySelector('.app-date').textContent.replace('Applied: ', '');
        const deadline = card.querySelector('.app-deadline').textContent.replace('Deadline: ', '');
        const description = card.querySelector('.app-desc').textContent;
        const note = card.dataset.note || ''; // Get the note from data attribute
        const opportunityType = card.dataset.opportunityType || 'Not specified';
        const tagsString = card.dataset.tags || '';
        const tags = tagsString ? tagsString.split(',') : [];
        
        // Populate modal
        document.getElementById('modalJobTitle').textContent = jobTitle;
        document.getElementById('modalOrganization').textContent = organization;
        document.getElementById('modalAppliedDate').textContent = appliedDate;
        document.getElementById('modalDeadline').textContent = deadline;
        document.getElementById('modalDescription').textContent = description;
        document.getElementById('modalPositionType').textContent = opportunityType;
        document.getElementById('resumeFileName').textContent = 'resume.pdf';
        document.getElementById('modalNotes').textContent = note || 'No additional notes provided.'; // Use the note or default text
        
        // Populate tags
        const tagsContainer = document.getElementById('modalTags');
        tagsContainer.innerHTML = ''; // Clear existing tags
        if (tags.length > 0) {
          tags.forEach(tag => {
            const tagElement = document.createElement('span');
            tagElement.className = 'tag';
            tagElement.textContent = tag.trim();
            tagsContainer.appendChild(tagElement);
          });
        } else {
          tagsContainer.innerHTML = '<span class="no-tags">No tags specified</span>';
        }
        
        const badge = document.getElementById('modalStatus');
        badge.className = statusClass;
        badge.textContent = statusText;
      }
      
      modal.style.display = 'block';
      document.body.style.overflow = 'hidden';
    }
    function closeApplicationModal() {
      modal.style.display = 'none';
      document.body.style.overflow = 'auto';
    }
    function downloadResume() {
      const fileName = document.getElementById('resumeFileName').textContent;
      showToast(`Downloading resume: ${fileName}`);
      
      // Show download notification
      showInfoMessage('Download Started', `Downloading ${fileName}...`);
      
      // Simulate download completion
      setTimeout(function() {
        showSuccessMessage('Download Complete', `${fileName} downloaded successfully!`);
      }, 2000);
    }

    /* ===== Toast Notification ===== */
    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = 'toast show';
      setTimeout(()=>{ toast.className='toast'; },3000);
    }

    const bell = document.getElementById("notifBell");
    const dropdown = document.getElementById("notifDropdown");

    bell.addEventListener("click", () => {
        dropdown.classList.toggle("show");
    });

    document.addEventListener("click", function(e) {
        if (!bell.contains(e.target) && !dropdown.contains(e.target)) {
            dropdown.classList.remove("show");
        }
    });


  </script>
  
  <!-- Include the error message component JavaScript -->
  <script src="{% static 'Myapp/error_message.js' %}"></script>
</body>
</html>