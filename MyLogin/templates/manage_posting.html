{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Manage Postings - CampusLink</title>

  <link rel="stylesheet" href="{% static 'Myapp/manage_posting.css' %}?v=1.0">
  <link rel="stylesheet" href="{% static 'Myapp/org_dashboard.css' %}">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;600&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"/>
</head>

<body>
  <header class="header">
    <div class="logo">
      <i class="fa-solid fa-graduation-cap"></i>
      <span>CampusLink</span>
    </div>

    <nav>
      <a href="{% url 'organization_dashboard' %}">Dashboard</a>
      <a href="{% url 'post_opportunity' %}">Post Opportunity</a>
      <a href="{% url 'manage_postings' %}" class="active">Applicants</a>
      <a href="{% url 'org_profile' %}">Profile</a>
    </nav>
    

    <div class="search-profile">
      <input type="text" class="top-search" placeholder="Search opportunities...">

      <!-- üîî NOTIFICATION BELL (CLEAN VERSION) -->
<!-- üîî NOTIFICATION BELL ‚Äî FULL STUDENT STYLE -->
<div class="notification-wrapper">
    <div id="notifBell" class="notif-bell">
        <i class="fa-solid fa-bell"></i>
        {% if unread_count > 0 %}
            <span class="notif-badge">{{ unread_count }}</span>
        {% endif %}
    </div>

    <div id="notifDropdown" class="notif-dropdown">

        <div class="notif-header">Notifications</div>

        {% if notifications %}
            {% for n in notifications %}
                <div class="notif-item {% if not n.read %}notif-unread{% endif %}">
                    <div class="notif-title">{{ n.title }}</div>
                    <div class="notif-time">{{ n.timestamp|timesince }} ago</div>
                </div>
            {% endfor %}
        {% else %}
            <div class="notif-empty">
                <i class="fa-regular fa-bell"></i>
                <p>No notifications yet</p>
            </div>
        {% endif %}
    </div>
</div>

      <!-- PROFILE DROPDOWN -->
      <div class="profile-dropdown" id="orgProfileDropdown">
          <img src="{% if user.profile.profile_picture %}
                        {{ user.profile.profile_picture.url }}
                   {% else %}
                        /static/Myapp/default-avatar.png
                   {% endif %}"
               alt="Profile"
               class="avatar"
               id="profileAvatar">

          <div class="dropdown-menu" id="orgDropdownMenu">
              <div class="dropdown-header">Organization</div>
              <a href="{% url 'org_profile' %}"><i class="fa-solid fa-user"></i> Profile</a>
              <a href="{% url 'submit_verification' %}"><i class="fa-solid fa-shield-check"></i> Verify Organization</a>
              <a href="{% url 'org_settings' %}"><i class="fa-solid fa-gear"></i> Settings</a>
              <a href="{% url 'logout' %}"><i class="fa-solid fa-right-from-bracket"></i> Log out</a>
          </div>
      </div>
    </div>
  </header>

  <main>
    <section class="content">
      <div class="dashboard-title">
        <h1>Manage <span>Postings</span></h1>
        <p>View, edit, or delete your organization's postings.</p>
      </div>

      <div class="recent-section">
        <div class="recent-postings">
          {% if postings %}
            {% for post in postings %}
              <div class="posting-card" data-id="{{ post.id }}">
                <div class="posting-info">
                  <span class="title">{{ post.title }}</span>
                  <span class="status {% if post.status == 'Active' %}active{% else %}closed{% endif %}">
                    {{ post.status }}
                  </span>
                </div>

                <div class="description">
                  <p>{{ post.description|default:"No description provided" }}</p>
                </div>

                <div class="details">
                  <small>Deadline: {{ post.deadline|date:"Y-m-d" }} ¬∑ Status: {{ post.status }}</small>
                </div>

                <div class="actions-grid">
                  <button class="action edit-btn">‚úèÔ∏è Edit</button>
                  <button class="action delete-btn">üóë Delete</button>
                  <a href="#" class="action view-applicants">üë• View Applicants</a>
                </div>
              </div>
            {% endfor %}
          {% else %}
            <p>No postings found. Create your first opportunity!</p>
          {% endif %}
        </div>
      </div>
    </section>
  </main>

  <!-- Edit Modal -->
  <div id="editModal" class="modal">
    <div class="modal-content">
      <h3>Edit Posting</h3>
      <form id="editForm">
        <input type="hidden" id="editPostId">

        <label>Title:</label>
        <input type="text" id="editTitle" required />
        <small class="instruction">Enter a clear and concise title for your posting.</small>

        <label>Description:</label>
        <textarea id="editDescription" rows="4"></textarea>
        <small class="instruction">Describe the posting in detail. Include purpose, requirements, etc.</small>

        <label>Deadline:</label>
        <input type="date" id="editDeadline" required />
        <small class="instruction">Select the last day that applicants can submit their application.</small>

        <label>Status:</label>
        <select id="editStatus">
          <option value="active">Active</option>
          <option value="closed">Closed</option>
        </select>
        <small class="instruction">Choose whether the posting is currently open or closed.</small>

        <div class="modal-actions">
          <button type="submit" class="modal-action-btn save">Save</button>
          <button type="button" id="cancelEdit" class="modal-action-btn cancel">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div id="deleteModal" class="modal">
    <div class="modal-content">
      <h3>Delete Posting</h3>
      <p>Are you sure you want to delete this posting?</p>
      <div class="modal-actions">
        <button type="button" id="confirmDelete" class="modal-action-btn delete">Yes, Delete</button>
        <button type="button" id="cancelDelete" class="modal-action-btn cancel">Cancel</button>
      </div>
    </div>
  </div>

  <script>
    /* ============================
       DROPDOWN (STUDENT STYLE)
    ============================ */
    document.getElementById("profileAvatar").addEventListener("click", function () {
        const menu = document.getElementById("orgDropdownMenu");
        menu.style.display = menu.style.display === "flex" ? "none" : "flex";
    });

    // Close dropdown when clicking outside
    document.addEventListener("click", function (event) {
        if (!event.target.closest(".profile-dropdown")) {
            const menu = document.getElementById("orgDropdownMenu");
            if (menu) menu.style.display = "none";
        }
    });

    /* ============================
       VERIFICATION MODAL
    ============================ */
    function closeVerificationModal() {
        // This function would need to be implemented if you want to include verification modals
        // For now, we'll just have the placeholder
    }

    function openVerificationModal() {
        // This function would need to be implemented if you want to include verification modals
        // For now, we'll just have the placeholder
        alert('Verification functionality would be implemented here');
    }

    // Manage postings functionality
    document.addEventListener("DOMContentLoaded", () => {
      const editModal = document.getElementById("editModal");
      const editForm = document.getElementById("editForm");
      const editPostId = document.getElementById("editPostId");
      const editTitle = document.getElementById("editTitle");
      const editDescription = document.getElementById("editDescription");
      const editDeadline = document.getElementById("editDeadline");
      const editStatus = document.getElementById("editStatus");
      const cancelEdit = document.getElementById("cancelEdit");

      const deleteModal = document.getElementById("deleteModal");
      const confirmDelete = document.getElementById("confirmDelete");
      const cancelDelete = document.getElementById("cancelDelete");

      const postingSearch = document.querySelector(".top-search");

      let currentCard = null;

      // Search postings
      postingSearch.addEventListener("input", () => {
        const searchTerm = postingSearch.value.toLowerCase();
        document.querySelectorAll('.posting-card').forEach(card => {
          const text = card.textContent.toLowerCase();
          card.style.display = text.includes(searchTerm) ? 'block' : 'none';
        });
      });

      // Open Edit Modal
      document.querySelectorAll(".edit-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          currentCard = btn.closest(".posting-card");
          const postId = currentCard.dataset.id;
          const titleEl = currentCard.querySelector(".title");
          const descriptionEl = currentCard.querySelector(".description p");
          const detailsText = currentCard.querySelector(".details small").textContent;
          const deadlineMatch = detailsText.match(/Deadline: ([^¬∑]+)/);
          const deadlineText = deadlineMatch ? deadlineMatch[1].trim() : "";
          const statusEl = currentCard.querySelector(".status");

          editPostId.value = postId;
          editTitle.value = titleEl.textContent.trim();
          editDescription.value = descriptionEl.textContent.trim();
          editDeadline.value = deadlineText;
          editStatus.value = statusEl.textContent.trim().toLowerCase() === "active" ? "active" : "closed";

          editModal.classList.add("active");
        });
      });

      // Save Edit
      editForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        const postId = editPostId.value;
        const formData = new FormData();
        formData.append('title', editTitle.value);
        formData.append('deadline', editDeadline.value);
        formData.append('description', editDescription.value);
        formData.append('status', editStatus.value === "active" ? "Active" : "Closed");

        try {
          const response = await fetch(`/organization/edit-posting/${postId}/`, {
            method: 'POST',
            headers: { 'X-CSRFToken': getCookie('csrftoken') },
            body: formData
          });

          if (response.ok) {
            const titleEl = currentCard.querySelector(".title");
            const descriptionEl = currentCard.querySelector(".description p");
            const detailsEl = currentCard.querySelector(".details small");
            const statusEl = currentCard.querySelector(".status");

            titleEl.textContent = editTitle.value;
            descriptionEl.textContent = editDescription.value;
            detailsEl.textContent = `Deadline: ${editDeadline.value} ¬∑ Status: ${editStatus.value === "active" ? "Active" : "Closed"}`;
            statusEl.textContent = editStatus.value === "active" ? "Active" : "Closed";
            statusEl.className = `status ${editStatus.value === "active" ? "active" : "closed"}`;

            editModal.classList.remove("active");
            showToast('Posting updated successfully!', 'success');
          } else {
            showToast('Failed to update posting', 'error');
          }
        } catch (error) {
          console.error('Error:', error);
          showToast('Error updating posting', 'error');
        }
      });

      // Cancel Edit
      cancelEdit.addEventListener("click", () => editModal.classList.remove("active"));

      // Delete Modal
      document.querySelectorAll(".delete-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          currentCard = btn.closest(".posting-card");
          deleteModal.classList.add("active");
        });
      });

      confirmDelete.addEventListener("click", async () => {
        if (!currentCard) return;
        const postId = currentCard.dataset.id;
        try {
          const response = await fetch(`/organization/delete-posting/${postId}/`, {
            method: 'POST',
            headers: { 'X-CSRFToken': getCookie('csrftoken') },
          });
          if (response.ok) {
            currentCard.remove();
            showToast('Posting deleted successfully!', 'success');
          } else {
            showToast('Failed to delete posting', 'error');
          }
        } catch (error) {
          console.error(error);
          showToast('Error deleting posting', 'error');
        }
        deleteModal.classList.remove("active");
        currentCard = null;
      });

      cancelDelete.addEventListener("click", () => {
        deleteModal.classList.remove("active");
        currentCard = null;
      });

      function getCookie(name) {
        let cookieValue = null;
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.startsWith(name + '=')) {
            cookieValue = decodeURIComponent(cookie.slice(name.length + 1));
            break;
          }
        }
        return cookieValue;
      }

      function showToast(message, type='success') {
        const toast = document.createElement('div');
        toast.textContent = message;
        toast.className = `toast ${type}`;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
      }
    });

    
/* ============================
   NOTIFICATION DROPDOWN
============================ */
const notifBell = document.getElementById("notifBell");
const notifDropdown = document.getElementById("notifDropdown");

notifBell.addEventListener("click", function (event) {
    event.stopPropagation();
    notifDropdown.classList.toggle("show");
});

// Close dropdown when clicking outside
document.addEventListener("click", function (event) {
    if (!notifDropdown.contains(event.target) && !notifBell.contains(event.target)) {
        notifDropdown.classList.remove("show");
    }
});
  </script>
</body>
</html>