{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Manage Postings - CampusLink</title>

  <link rel="stylesheet" href="{% static 'Myapp/manage_posting.css' %}?v=2">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;600&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
</head>

<body>

<header>
  <div class="logo">🏫 CampusLink</div>

  <nav>
    <a href="{% url 'organization_dashboard' %}">Dashboard</a>
    <a href="{% url 'manage_postings' %}" class="active">Manage Postings</a>
     <a href="#">Post Opportunity</a>
    <a href="#">Applicants</a>
    <a href="#">Org Profile</a>
  </nav>

  <div class="nav-right">
    <input type="text" placeholder="Search postings..." />
    <button title="Notifications">🔔</button>
    <button title="Profile">👤</button>
  </div>
</header>

<main>
  <section class="content">
    <div class="dashboard-title">
      <h1>Manage <span>Postings</span></h1>
      <p>View, edit, or delete your organization's postings.</p>
    </div>

    <div class="recent-section">
      <div class="recent-postings">
        {% if postings %}
          {% for post in postings %}
            <div class="posting-card" data-id="{{ post.id }}">
              <div class="posting-info">
                <span class="title">{{ post.title }}</span>
                <span class="status {% if post.status == 'Active' %}active{% else %}closed{% endif %}">
                  {{ post.status }}
                </span>
              </div>

              <!-- ADDED DESCRIPTION HERE -->
              <div class="description">
                <p>{{ post.description|default:"No description provided" }}</p>
              </div>

              <div class="details">
                <small>Deadline: {{ post.deadline|date:"Y-m-d" }} · Status: {{ post.status }}</small>
              </div>

              <div class="actions-grid">
                <button class="action edit-btn" style="background:#3b82f6;">✏️ Edit</button>
                <button class="action delete-btn" style="background:#ef4444;">🗑 Delete</button>
                <a href="#" class="action">👥 View Applicants</a>
              </div>
            </div>
          {% endfor %}
        {% else %}
          <p>No postings found. Create your first opportunity!</p>
        {% endif %}
      </div>
    </div>
  </section>
</main>

<!-- Edit Modal -->
<div id="editModal" class="modal" style="display:none;">
  <div class="modal-content">
    <h3>Edit Posting</h3>
    <form id="editForm">
      <input type="hidden" id="editPostId">
      <label>Title:</label>
      <input type="text" id="editTitle" required />

      <label>Description:</label>
      <textarea id="editDescription" rows="4"></textarea>

      <label>Deadline:</label>
      <input type="date" id="editDeadline" required />

      <label>Status:</label>
      <select id="editStatus">
        <option value="active">Active</option>
        <option value="closed">Closed</option>
      </select>

      <div class="modal-actions" style="margin-top:16px; display:flex; justify-content:flex-end; gap:10px;">
        <button type="submit" class="action" style="background:#3b82f6;">Save</button>
        <button type="button" id="cancelEdit" class="action" style="background:#6b7280;">Cancel</button>
      </div>
    </form>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="modal" style="display:none;">
  <div class="modal-content">
    <h3>Delete Posting</h3>
    <p>Are you sure you want to delete this posting?</p>
    <div class="modal-actions" style="margin-top:16px; display:flex; justify-content:flex-end; gap:10px;">
      <button type="button" id="confirmDelete" class="action" style="background:#ef4444;">Yes, Delete</button>
      <button type="button" id="cancelDelete" class="action" style="background:#6b7280;">Cancel</button>
    </div>
  </div>
</div>

<!-- JavaScript -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const editModal = document.getElementById("editModal");
  const editForm = document.getElementById("editForm");
  const editPostId = document.getElementById("editPostId");
  const editTitle = document.getElementById("editTitle");
  const editDescription = document.getElementById("editDescription");
  const editDeadline = document.getElementById("editDeadline");
  const editStatus = document.getElementById("editStatus");
  const cancelEdit = document.getElementById("cancelEdit");
  
  const deleteModal = document.getElementById("deleteModal");
  const confirmDelete = document.getElementById("confirmDelete");
  const cancelDelete = document.getElementById("cancelDelete");

  let currentCard = null;
  let currentDeleteBtn = null;

  // 🖊️ Open Edit Modal
  document.querySelectorAll(".edit-btn").forEach((btn) => {
    btn.addEventListener("click", () => {
      currentCard = btn.closest(".posting-card");
      const postId = currentCard.dataset.id;
      const titleEl = currentCard.querySelector(".title");
      const descriptionEl = currentCard.querySelector(".description p");
      const detailsText = currentCard.querySelector(".details small").textContent;
      
      // Extract deadline from details text
      const deadlineMatch = detailsText.match(/Deadline: ([^·]+)/);
      const deadlineText = deadlineMatch ? deadlineMatch[1].trim() : "";
      
      const statusEl = currentCard.querySelector(".status");

      // Fill the form with current data
      editPostId.value = postId;
      editTitle.value = titleEl.textContent.trim();
      editDescription.value = descriptionEl.textContent.trim();
      editDeadline.value = deadlineText;
      editStatus.value = statusEl.textContent.trim().toLowerCase() === "active" ? "active" : "closed";

      editModal.style.display = "flex";
    });
  });

  // 💾 Save Edit - UPDATED TO SAVE TO BACKEND
  editForm.addEventListener("submit", async (e) => {
    e.preventDefault();

    const postId = editPostId.value;
    const formData = new FormData();
    formData.append('title', editTitle.value);
    formData.append('deadline', editDeadline.value);
    formData.append('description', editDescription.value);
    formData.append('status', editStatus.value === "active" ? "Active" : "Closed");

    try {
      const response = await fetch(`/organization/edit-posting/${postId}/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': getCookie('csrftoken'),
        },
        body: formData
      });

      if (response.ok) {
        // Update the frontend only after successful backend save
        const titleEl = currentCard.querySelector(".title");
        const descriptionEl = currentCard.querySelector(".description p");
        const detailsEl = currentCard.querySelector(".details small");
        const statusEl = currentCard.querySelector(".status");

        titleEl.textContent = editTitle.value;
        descriptionEl.textContent = editDescription.value;
        detailsEl.textContent = `Deadline: ${editDeadline.value} · Status: ${editStatus.value === "active" ? "Active" : "Closed"}`;
        statusEl.textContent = editStatus.value === "active" ? "Active" : "Closed";
        statusEl.className = `status ${editStatus.value === "active" ? "active" : "closed"}`;

        editModal.style.display = "none";
        showMessage('Posting updated successfully!', 'success');
      } else {
        showMessage('Failed to update posting');
      }
    } catch (error) {
      console.error('Error:', error);
      showMessage('Error updating posting');
    }
  });

  // ❌ Cancel Edit
  cancelEdit.addEventListener("click", () => {
    editModal.style.display = "none";
  });

  // 🗑️ Open Delete Confirmation Modal
  document.querySelectorAll(".delete-btn").forEach((btn) => {
    btn.addEventListener("click", () => {
      currentDeleteBtn = btn;
      currentCard = btn.closest(".posting-card");
      deleteModal.style.display = "flex";
    });
  });

  // ✅ Confirm Delete
  confirmDelete.addEventListener("click", async () => {
    if (currentCard) {
      const postId = currentCard.dataset.id;
      
      try {
        const response = await fetch(`/organization/delete-posting/${postId}/`, {
          method: 'POST',
          headers: {
            'X-CSRFToken': getCookie('csrftoken'),
          },
        });
        
        if (response.ok) {
          currentCard.remove();
          showMessage('Posting deleted successfully!', 'success');
        } else {
          showMessage('Failed to delete posting');
        }
      } catch (error) {
        console.error('Error:', error);
        showMessage('Error deleting posting');
      }
      
      deleteModal.style.display = "none";
      currentCard = null;
      currentDeleteBtn = null;
    }
  });

  // ❌ Cancel Delete
  cancelDelete.addEventListener("click", () => {
    deleteModal.style.display = "none";
    currentCard = null;
    currentDeleteBtn = null;
  });

  // Helper function to get CSRF token
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  // Instead of alert(), show a nice message on the page
  function showMessage(message, type = 'error') {
    // Create a notification element
    const notification = document.createElement('div');
    notification.textContent = message;
    notification.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 12px 20px;
      background: ${type === 'error' ? '#ef4444' : '#10b981'};
      color: white;
      border-radius: 8px;
      z-index: 1000;
      font-family: 'Inter', sans-serif;
      font-weight: 500;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    `;
    
    document.body.appendChild(notification);
    
    // Remove after 3 seconds
    setTimeout(() => {
      notification.remove();
    }, 3000);
  }
});
</script>

</body>
</html>