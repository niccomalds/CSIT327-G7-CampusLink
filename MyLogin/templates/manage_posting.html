{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Manage Postings - CampusLink</title>

  <link rel="stylesheet" href="{% static 'Myapp/manage_posting.css' %}?v=1.0">
  <link rel="stylesheet" href="{% static 'Myapp/org_dashboard.css' %}">
  
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;600&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"/>
</head>

<body>
  <header class="header">
    <div class="logo">
      <i class="fa-solid fa-graduation-cap"></i>
      <span>CampusLink</span>
    </div>

    <nav>
      <a href="{% url 'organization_dashboard' %}">Dashboard</a>
      <a href="{% url 'post_opportunity' %}">Post Opportunity</a>
      <a href="{% url 'manage_postings' %}" class="active">Applicants</a>
      <a href="{% url 'org_profile' %}">Org Profile</a>
    </nav>
    

    <div class="search-profile">

      <!-- üîî NOTIFICATION BELL ‚Äî SIMPLE VERSION (Same as Org Dashboard) -->
<div class="notification-wrapper">
    <a href="{% url 'notifications' %}" id="notifBell" class="notif-bell">
        <i class="fa-solid fa-bell"></i>
        {% if unread_count > 0 %}
            <span class="notif-badge">{{ unread_count }}</span>
        {% endif %}
    </a>
</div>


      <!-- PROFILE DROPDOWN -->
      <div class="profile-dropdown" id="orgProfileDropdown">
          <img src="{% if user.profile.profile_picture %}
                        {{ user.profile.profile_picture.url }}
                   {% else %}
                        /static/Myapp/default-avatar.png
                   {% endif %}"
               alt="Profile"
               class="avatar"
               id="profileAvatar">

          <div class="dropdown-menu" id="orgDropdownMenu">
              <div class="dropdown-header">Organization</div>
              <a href="{% url 'org_profile' %}"><i class="fa-solid fa-user"></i> Profile</a>
              <a href="{% url 'manage_postings' %}"><i class="fa-solid fa-users"></i> Applicants</a>
              <a href="{% url 'submit_verification' %}"><i class="fa-solid fa-shield-check"></i> Verify Organization</a>
              <a href="{% url 'org_settings' %}"><i class="fa-solid fa-gear"></i> Settings</a>
              <a href="{% url 'logout' %}"><i class="fa-solid fa-right-from-bracket"></i> Log out</a>
          </div>
      </div>
    </div>
  </header>

  <main>
    <section class="content">
      <div class="dashboard-title">
        <h1>Manage <span>Postings</span></h1>
        <p>View, edit, or delete your organization's postings.</p>
      </div>

      <div class="recent-section">
        <div class="recent-postings">
          {% if postings %}
            {% for post in postings %}
              <div class="posting-card" data-id="{{ post.id }}">
                <div class="posting-info">
                  <span class="title">{{ post.title }}</span>
                  <span class="status {% if post.status == 'Active' %}active{% else %}closed{% endif %}">
                    {{ post.status }}
                  </span>
                </div>

                <div class="description">
                  <p>{{ post.description|default:"No description provided" }}</p>
                </div>

                <div class="details">
                  <small>Deadline: {{ post.deadline|date:"Y-m-d" }} ¬∑ Status: {{ post.status }}</small>
                </div>

                <div class="actions-grid">
                  <button class="action edit-btn">‚úèÔ∏è Edit</button>
                  <button class="action delete-btn">üóë Delete</button>
                  <a href="#" class="action view-applicants">üë• View Applicants</a>
                </div>
              </div>
            {% endfor %}
          {% else %}
            <p>No postings found. Create your first opportunity!</p>
          {% endif %}
        </div>
      </div>
    </section>
  </main>

  <!-- Edit Modal -->
  <div id="editModal" class="modal">
    <div class="modal-content">
      <h3>Edit Posting</h3>
      <form id="editForm">
        <input type="hidden" id="editPostId">

        <label>Title:</label>
        <input type="text" id="editTitle" required />
        <small class="instruction">Enter a clear and concise title for your posting.</small>

        <label>Description:</label>
        <textarea id="editDescription" rows="4"></textarea>
        <small class="instruction">Describe the posting in detail. Include purpose, requirements, etc.</small>

        <label>Deadline:</label>
        <input type="date" id="editDeadline" required />
        <small class="instruction">Select the last day that applicants can submit their application.</small>

        <label>Status:</label>
        <select id="editStatus">
          <option value="active">Active</option>
          <option value="closed">Closed</option>
        </select>
        <small class="instruction">Choose whether the posting is currently open or closed.</small>

        <div class="modal-actions">
          <button type="submit" class="modal-action-btn save">Save</button>
          <button type="button" id="cancelEdit" class="modal-action-btn cancel">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div id="deleteModal" class="modal">
    <div class="modal-content">
      <h3>Delete Posting</h3>
      <p>Are you sure you want to delete this posting?</p>
      <div class="modal-actions">
        <button type="button" id="confirmDelete" class="modal-action-btn delete">Yes, Delete</button>
        <button type="button" id="cancelDelete" class="modal-action-btn cancel">Cancel</button>
      </div>
    </div>
  </div>

  <script>
    /* ===== Profile Dropdown ===== */
    const avatar = document.getElementById('profileAvatar');
    const menu = document.getElementById('profileMenu');
    
    if (avatar && menu) {
      avatar.addEventListener('click', () => {
        menu.parentElement.classList.toggle('show');
      });
      window.addEventListener('click', (e) => {
        if (!avatar.contains(e.target) && !menu.contains(e.target)) {
          menu.parentElement.classList.remove('show');
        }
      });
    }

    /* ===== Search & Filter ===== */
    const searchInput = document.getElementById('applicationSearch');
    searchInput?.addEventListener('input', function() {
      const term = this.value.toLowerCase();
      document.querySelectorAll('.application-card').forEach(card => {
        card.style.display = card.textContent.toLowerCase().includes(term) ? 'block' : 'none';
      });
    });

    const statusFilter = document.getElementById('statusFilter');
    statusFilter?.addEventListener('change', function() {
      const selected = this.value.toLowerCase().replace(' ', '_');
      document.querySelectorAll('.application-card').forEach(card => {
        const status = card.dataset.status;
        card.style.display = selected === 'all_status' ? 'block' :
                             (status === selected ? 'block' : 'none');
      });
    });

    /* ===== Withdrawal ===== */
    let currentWithdrawId = null;
    function showWithdrawConfirmation(id) {
      currentWithdrawId = id;
      const card = document.querySelector(`[data-application-id="${id}"]`);
      document.getElementById('withdrawJobTitle').textContent = card.querySelector('h3').textContent;
      document.getElementById('withdrawOrganization').textContent = card.querySelector('.app-org').textContent;
      document.getElementById('withdrawModal').style.display = 'block';
      document.body.style.overflow = 'hidden';
    }
    function closeWithdrawModal() {
      document.getElementById('withdrawModal').style.display = 'none';
      document.body.style.overflow = 'auto';
      currentWithdrawId = null;
    }
    function confirmWithdrawal() {
      if (!currentWithdrawId) return;
      
      const processingMsg = showInfoMessage('Processing', 'Withdrawing application...', false);
      
      setTimeout(function() {
        processingMsg.querySelector('.alert-close').click();
        
        if (Math.random() > 0.2) {
          simulateWithdrawal(currentWithdrawId);
          closeWithdrawModal();
          showSuccessMessage('Success', 'Application withdrawn successfully!');
          showToast('Application withdrawn successfully!');
        } else {
          showErrorMessage('Error', 'Failed to withdraw application. Please try again.');
        }
      }, 1500);
    }
    function simulateWithdrawal(id) {
      const card = document.querySelector(`[data-application-id="${id}"]`);
      const statusBadge = card.querySelector('.status-badge');
      const withdrawBtn = card.querySelector('.withdraw-btn');
      card.dataset.status = 'withdrawn';
      statusBadge.className = 'status-badge status-withdrawn';
      statusBadge.innerHTML = '<i class="fa-solid fa-ban"></i> Withdrawn';
      withdrawBtn?.remove();
      updateStatistics();
    }

    /* ===== Update Statistics ===== */
    function updateStatistics() {
      const counts = { submitted: 0, under_review: 0, accepted: 0, rejected: 0, withdrawn: 0 };
      document.querySelectorAll('.application-card').forEach(card => counts[card.dataset.status]++);
      const total = Object.values(counts).reduce((a,b)=>a+b,0);
      document.getElementById('totalApplications').textContent = total;
      document.getElementById('submittedApplications').textContent = counts.submitted;
      document.getElementById('reviewApplications').textContent = counts.under_review;
      document.getElementById('acceptedApplications').textContent = counts.accepted;
      document.getElementById('rejectedApplications').textContent = counts.rejected;
      document.getElementById('withdrawnApplications').textContent = counts.withdrawn;
    }

    /* ===== Application Details Modal ===== */
    const modal = document.getElementById('applicationModal');
    function openApplicationModal(id) {
      const data = getSampleApplicationData(id);
      populateModalData(data);
      modal.style.display = 'block';
      document.body.style.overflow = 'hidden';
    }
    function closeApplicationModal() {
      modal.style.display = 'none';
      document.body.style.overflow = 'auto';
    }

    function populateModalData(data) {
      document.getElementById('modalJobTitle').textContent = data.jobTitle;
      document.getElementById('modalOrganization').textContent = data.organization;
      document.getElementById('modalAppliedDate').textContent = data.appliedDate;
      document.getElementById('modalDeadline').textContent = data.deadline;
      document.getElementById('modalWorkMode').textContent = data.workMode;
      document.getElementById('modalPositionType').textContent = data.positionType;
      document.getElementById('modalDescription').textContent = data.description;
      document.getElementById('resumeFileName').textContent = data.resumeFile;
      document.getElementById('modalNotes').textContent = data.notes;

      const badge = document.getElementById('modalStatus');
      badge.className = `status-badge status-${data.status}`;

      let icon = '', text = '';
      switch(data.status){
        case 'submitted': icon='fa-regular fa-clock'; text='Submitted'; break;
        case 'under_review': icon='fa-regular fa-eye'; text='Under Review'; break;
        case 'accepted': icon='fa-solid fa-check'; text='Accepted'; break;
        case 'rejected': icon='fa-solid fa-xmark'; text='Rejected'; break;
        case 'withdrawn': icon='fa-solid fa-ban'; text='Withdrawn'; break;
      }
      badge.innerHTML = `<i class="${icon}"></i> ${text}`;
    }

    function downloadResume() {
      const fileName = document.getElementById('resumeFileName').textContent;
      showToast(`Downloading resume: ${fileName}`);
      showInfoMessage('Download Started', `Downloading ${fileName}...`);
      setTimeout(() => {
        showSuccessMessage('Download Complete', `${fileName} downloaded successfully!`);
      }, 2000);
    }

    function getSampleApplicationData(id) {
      const sampleData = {
        1:{jobTitle:"Software Engineering Intern",organization:"Tech Innovations Lab",status:"submitted",appliedDate:"Jan 15",deadline:"Feb 15",workMode:"Remote",positionType:"Internship",description:"Full-stack internship.",resumeFile:"john_doe_resume.pdf",notes:"Excited to join."},
      };
      return sampleData[id] || sampleData[1];
    }

    /* ===== Toast Notification ===== */
    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = 'toast show';
      setTimeout(()=>{ toast.className='toast'; },3000);
    }

    /* ===== NOTIFICATION (Updated to Direct Link) ===== */
    const bell = document.getElementById("notifBell");

    bell.addEventListener("click", () => {
        // Redirect directly to notifications page
        window.location.href = "{% url 'notifications' %}";
    });
</script>

</body>
</html>