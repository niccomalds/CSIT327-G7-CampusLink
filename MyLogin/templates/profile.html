{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CampusLink – Student Profile</title>
  <link rel="stylesheet" href="{% static 'Myapp/profile.css' %}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="logo"><i class="fa-solid fa-graduation-cap"></i> CampusLink</div>
    <nav>
      <a href="{% url 'student_dashboard' %}">Home</a>
      <a href="#">My Applications</a>
      <a href="#" class="active">Profile</a>
      <a href="#">Notifications</a>
    </nav>
    <div class="search-profile" id="userMenuWrap">
      <input type="text" class="top-search" placeholder="Search opportunities...">
      <button id="userToggle" aria-expanded="false" aria-controls="userDropdown" class="avatar-btn">
        <img src="{% static 'Myapp/profile.jpg' %}" alt="User avatar" class="avatar"/>
      </button>
      <div id="userDropdown" class="dropdown-menu" role="menu" aria-label="User menu" hidden>
        <div class="dropdown-item dropdown-user" role="menuitem">Student</div>
        <hr class="dropdown-separator"/>
        <div class="dropdown-item" role="menuitem" id="profileBtn"><i class="fa-regular fa-user"></i> Profile</div>
        <div class="dropdown-item" role="menuitem" id="settingsBtn"><i class="fa-solid fa-gear"></i> Settings</div>
        <div class="dropdown-item" role="menuitem" id="logoutBtn"><i class="fa-solid fa-right-from-bracket"></i> Log out</div>
      </div>
    </div>
  </header>

  <!-- Profile Section -->
  <main class="profile-main">
    <button id="editBtn" class="edit-profile-btn"><i class="fa-solid fa-pen-to-square"></i> Edit Profile</button>
    <button id="saveBtn" class="edit-profile-btn" style="display:none; background: #34d399;">Save Changes</button>
    <div class="profile-layout">
      <!-- Sidebar -->
      <aside class="profile-side">
        <div class="profile-card">
          <img src="{% static 'Myapp/profile.jpg' %}" class="profile-photo" alt="Student Avatar">
          <div class="profile-major-year" id="majorYearView">
            {{ request.user.profile.major }} • {{ request.user.profile.academic_year }}
          </div>
          <div class="profile-info-list" id="infoListView">
            <div><i class="fa-regular fa-envelope"></i> <span id="emailView">{{ request.user.email }}</span></div>
            <div><i class="fa-solid fa-phone"></i> <span id="phoneView">{{ request.user.profile.phone }}</span></div>
            <div><i class="fa-solid fa-graduation-cap"></i> <span id="majorView">{{ request.user.profile.major }}</span></div>
            <div><i class="fa-regular fa-calendar"></i> <span id="yearView">{{ request.user.profile.academic_year }}</span></div>
          </div>
          <hr>
          <div class="profile-links" id="portfolioLinksView">
            <strong>Portfolio Links</strong><br>
            <div id="linksListView"></div>
          </div>
          <hr>
          <div class="profile-resume">
            <strong>Resume</strong>
            <button class="resume-btn" disabled id="resumeBtnView">
              <i class="fa-regular fa-file"></i> Upload Resume
            </button>
          </div>
        </div>
      </aside>
      <!-- Form Section -->
      <section class="profile-form-section">
        <form method="post" class="profile-form" autocomplete="off">
          {% csrf_token %}
          <fieldset>
            <legend><strong><i class="fa-regular fa-address-card"></i> Personal Information</strong></legend>
            <div class="profile-form-row">
              <div class="profile-form-group">
                <label for="full_name">Full Name</label>
                <input type="text" id="full_name" name="full_name" value="{{ request.user.profile.full_name }}" disabled>
              </div>
              <div class="profile-form-group">
                <label for="email">Email</label>
                <input type="email" id="email" value="{{ request.user.email }}" disabled>
              </div>
            </div>
            <div class="profile-form-row">
              <div class="profile-form-group">
                <label for="phone">Phone</label>
                <input type="tel" id="phone" name="phone" value="{{ request.user.profile.phone }}" disabled>
              </div>
              <div class="profile-form-group">
                <label for="academic_year">Academic Year</label>
                <input type="text" id="academic_year" name="academic_year" value="{{ request.user.profile.academic_year }}" disabled>
              </div>
            </div>
            <div class="profile-form-row">
              <div class="profile-form-group">
                <label for="major">Course/Major</label>
                <input type="text" id="major" name="major" value="{{ request.user.profile.major }}" disabled>
              </div>
            </div>
            <div class="profile-form-row">
              <div class="profile-form-group" style="flex:2;">
                <label for="bio">Bio</label>
                <textarea id="bio" name="bio" rows="3" placeholder="Write something about yourself..." disabled>{{ request.user.profile.bio }}</textarea>
              </div>
            </div>
          </fieldset>
        </form>
        <!-- Skills and Portfolio Links -->
        <div class="profile-skills">
          <fieldset>
            <legend><strong><i class="fa-solid fa-lightbulb"></i> Skills</strong></legend>
            <div class="skills-desc">Add skills that showcase your expertise to potential organizations.</div>
            <div class="skills-list" id="skillsList"></div>
            <div id="skillInputWrap" style="display:none; margin-top:10px;">
              <input type="text" id="newSkill" placeholder="Add a skill..." />
              <button type="button" id="addSkillBtn">+</button>
            </div>
          </fieldset>
        </div>
        <div id="portfolioLinkEditBlock" style="display:none;">
          <fieldset class="portfolio-fieldset">
            <legend>
              <strong><i class="fa-solid fa-link"></i> Add Portfolio Link</strong>
            </legend>
            <div class="portfolio-form-row">
              <input type="text" id="portfolioName" class="portfolio-input" placeholder="Link name (e.g. GitHub)" />
              <input type="url" id="portfolioURL" class="portfolio-input" placeholder="URL" />
              <button type="button" id="addLinkBtn" class="portfolio-add-btn">Add Link</button>
            </div>
            <div id="portfolioLinksEdit" style="margin-top:16px;"></div>
          </fieldset>
        </div>
      </section>
    </div>
  </main>
  <!-- ✅ Scripts -->
  <script>
    // Dropdown Toggle
    const userToggle = document.getElementById("userToggle");
    const userDropdown = document.getElementById("userDropdown");
    userToggle.addEventListener("click", () => {
      const isHidden = userDropdown.hasAttribute("hidden");
      if (isHidden) {
        userDropdown.removeAttribute("hidden");
        userToggle.setAttribute("aria-expanded", "true");
      } else {
        userDropdown.setAttribute("hidden", "");
        userToggle.setAttribute("aria-expanded", "false");
      }
    });
    // Edit / Save Profile toggle logic
    const editBtn = document.getElementById("editBtn");
    const saveBtn = document.getElementById("saveBtn");
    const inputs = document.querySelectorAll("input[name], textarea[name]");
    const skillInputWrap = document.getElementById("skillInputWrap");
    const portfolioBlock = document.getElementById("portfolioLinkEditBlock");
    editBtn.addEventListener("click", () => {
      inputs.forEach(i => i.disabled = false);
      editBtn.style.display = "none";
      saveBtn.style.display = "inline-block";
      skillInputWrap.style.display = "flex";
      portfolioBlock.style.display = "block";
    });
    saveBtn.addEventListener("click", () => {
      // Submit the form on save
      document.querySelector('.profile-form').submit();
    });

    // Skills logic (unchanged)
    const skillsList = document.getElementById("skillsList");
    const addSkillBtn = document.getElementById("addSkillBtn");
    const newSkill = document.getElementById("newSkill");
    addSkillBtn.addEventListener("click", () => {
      const skill = newSkill.value.trim();
      if (skill) {
        const skillDiv = document.createElement("div");
        skillDiv.classList.add("skill-item");
        skillDiv.textContent = skill;
        const removeBtn = document.createElement("span");
        removeBtn.textContent = "×";
        removeBtn.classList.add("remove-skill");
        removeBtn.onclick = () => skillDiv.remove();
        skillDiv.appendChild(removeBtn);
        skillsList.appendChild(skillDiv);
        newSkill.value = "";
      }
    });
    // Portfolio Links logic (unchanged)
    const addLinkBtn = document.getElementById("addLinkBtn");
    const portfolioName = document.getElementById("portfolioName");
    const portfolioURL = document.getElementById("portfolioURL");
    const linksListView = document.getElementById("linksListView");
    const portfolioLinksEdit = document.getElementById("portfolioLinksEdit");

    // Create link without delete button for view mode
    const createViewLink = (name, url) => {
      const linkEl = document.createElement("div");
      linkEl.classList.add("portfolio-link");
      linkEl.innerHTML = `<a href="${url}" target="_blank">${name}</a>`;
      return linkEl;
    };

    // Create link with delete button for edit mode
    const createEditLink = (name, url) => {
      const linkEl = document.createElement("div");
      linkEl.classList.add("portfolio-link");
      linkEl.innerHTML = `
        <a href="${url}" target="_blank">${name}</a>
        <button type="button" class="remove-link" style="margin-left: 8px; color: #dc2626; background: none; border: none; cursor: pointer; font-weight: bold;">×</button>
      `;
      linkEl.querySelector(".remove-link").addEventListener("click", () => {
        linkEl.remove();
      });
      return linkEl;
    };

    addLinkBtn.addEventListener("click", () => {
      const name = portfolioName.value.trim();
      const url = portfolioURL.value.trim();
      if (name && url) {
        // Add link without delete button to view section
        const viewLink = createViewLink(name, url);
        linksListView.appendChild(viewLink);

        // Add link with delete button to edit section
        const editLink = createEditLink(name, url);
        portfolioLinksEdit.appendChild(editLink);

        // Clear inputs
        portfolioName.value = "";
        portfolioURL.value = "";
      }
      
    });
  </script>
</body>
</html>
