{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CampusLink â€“ Student Profile</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="{% static 'Myapp/profile.css' %}?v=1.3">
  <link rel="stylesheet" href="{% static 'Myapp/applications_main.css' %}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <!-- Include the error message component CSS -->
  <link rel="stylesheet" href="{% static 'Myapp/error_message.css' %}">
    <style>
        .skill-add-btn{background:#00c6ff;color:#fff;border:none;padding:6px 10px;border-radius:8px;cursor:pointer;font-weight:700;margin-left:6px}
        .skill-add-btn:hover{filter:brightness(.95)}
        .skill-item{display:inline-flex;align-items:center;gap:6px;background:#eef9ff;padding:6px 8px;border-radius:8px;margin:4px}
        .remove-skill{margin-left:6px;color:#dc2626;cursor:pointer}
    </style>
</head>

<body>

<!-- Alert container for global error messages -->
<div class="alert-container"></div>

<header class="sticky top-0 z-40 bg-white">
    <!-- full-width header background; inner container centers content -->
    <div class="w-full left-0 right-0 shadow-[0_4px_12px_rgba(0,0,0,0.08)]">
        <div class="max-w-[1400px] mx-auto w-full flex items-center justify-between px-12 py-4 rounded-b-[16px] ">

            <div class="logo flex items-center gap-3 text-[#00c6ff]">
                <i class="fa-solid fa-graduation-cap text-2xl"></i>
                <span class="text-2xl font-extrabold">CampusLink</span>
            </div>

            <nav class="flex items-center">
                <a href="{% url 'student_dashboard' %}" class="text-gray-600 justify-center text-center font-medium text-base pb-1 border-b-2 border-transparent hover:text-[#00c6ff] hover:border-[#00c6ff]">Home</a>
                <a href="{% url 'my_applications' %}" class="text-gray-600 justify-center text-center font-medium text-base pb-1 border-b-2 border-transparent hover:text-[#00c6ff] hover:border-[#00c6ff]">My Applications</a>
                <a href="{% url 'profile' %}" class="text-[#00c6ff] justify-center text-center font-medium text-base pb-1 border-b-2 border-[#00c6ff] active">Profile</a>
            </nav>

            <div class="search-profile flex items-center gap-4">

                <!-- ðŸ”” NOTIFICATION BELL -->
                <div class="notification-wrapper relative">
                    <a href="{% url 'student_notification' %}" id="notifBell" class="notif-bell text-gray-600 hover:text-[#00c6ff] relative">
                        <i class="fa-solid fa-bell"></i>
                        {% if unread_count > 0 %}
                        <span class="notif-badge">{{ unread_count }}</span>
                        {% endif %}
                    </a>
                </div>

                <!-- PROFILE DROPDOWN -->
                <div class="profile-dropdown">
                    <img src="{% if user.profile.profile_picture %}{{ user.profile.profile_picture.url }}{% else %}{% static 'Myapp/default-avatar.png' %}{% endif %}"
                             alt="Profile"
                             class="avatar"
                             id="profileAvatar">

                    <div class="dropdown-menu" id="profileMenu">
                        <div class="dropdown-header">Student</div>

                        <a href="{% url 'profile' %}">
                            <i class="fa-solid fa-user"></i> Profile
                        </a>

                        <a href="{% url 'logout' %}">
                            <i class="fa-solid fa-right-from-bracket"></i> Log out
                        </a>
                    </div>
                </div>

            </div>

        </div>
    </div>
</header>



<main class="profile-main">
    <button id="editBtn" class="edit-profile-btn"><i class="fa-solid fa-pen-to-square"></i> Edit Profile</button>
    <button id="saveBtn" class="edit-profile-btn" style="display:none; background:#34d399;">Save Changes</button>

    <div class="profile-layout">

        <!-- SIDEBAR -->
        <aside class="profile-side">
            <div class="profile-card">

                <img src="{% if user.profile.profile_picture %}
                    {{ user.profile.profile_picture.url }}
                  {% else %}
                    {% static 'Myapp/default-avatar.png' %}
                  {% endif %}"
                alt="Student Avatar" class="profile-photo">

                <div class="profile-major-year" id="majorYearView">
                    {{ profile.major }} â€¢ {{ profile.academic_year }}
                </div>

                <div class="profile-info-list" id="infoListView">
                    <div><i class="fa-regular fa-envelope"></i> <span id="emailView">{{ profile.user.email }}</span></div>
                    <div><i class="fa-solid fa-phone"></i> <span id="phoneView">{{ profile.phone }}</span></div>
                    <div><i class="fa-solid fa-graduation-cap"></i> <span id="majorView">{{ profile.major }}</span></div>
                    <div><i class="fa-regular fa-calendar"></i> <span id="yearView">{{ profile.academic_year }}</span></div>
                </div>

                <hr>

                <div class="profile-links" id="portfolioLinksView">
                    <strong>Portfolio Links</strong><br>
                    <div id="linksListView"></div>
                </div>

                <hr>

            </div>
        </aside>


        <!-- FORM SECTION -->
        <section class="profile-form-section">

<form class="profile-form" method="POST" action="{% url 'update_profile' %}" enctype="multipart/form-data">
    {% csrf_token %}
    <input type="hidden" name="skills" id="skillsInput" />
    <input type="hidden" name="portfolio_links" id="portfolioInput" />
    <fieldset>
        <legend><strong><i class="fa-regular fa-address-card"></i> Personal Information</strong></legend>

        <div class="profile-form-group" id="profilePictureWrapper" style="display:none;">
            <label for="profile_picture">Profile Picture</label>
            <input type="file" name="profile_picture" id="profile_picture" accept="image/*" disabled>
        </div>

        <div class="profile-form-row">
            <div class="profile-form-group">
                <label for="fullName">Full Name</label>
                <input type="text" id="fullName" name="full_name" value="{{ user.get_full_name }}" disabled>

            </div>

            <div class="profile-form-group">
                <label for="email">Email</label>
                <input type="email" id="email" name="email" value="{{ profile.user.email }}" disabled>
            </div>
        </div>

        <div class="profile-form-row">
            <div class="profile-form-group">
                <label for="phone">Phone</label>
                <input type="tel" id="phone" name="phone" value="{{ profile.phone }}" disabled>
            </div>

            <div class="profile-form-group">
                <label for="year">Academic Year</label>
                <input type="text" id="year" name="academic_year" value="{{ profile.academic_year }}" disabled>
            </div>
        </div>

        <div class="profile-form-row">
            <div class="profile-form-group">
                <label for="major">Course/Major</label>
                <input type="text" id="major" name="major" value="{{ profile.major }}" disabled>
            </div>
        </div>

        <div class="profile-form-row">
            <div class="profile-form-group" style="flex:2;">
                <label for="bio">Bio</label>
                <textarea id="bio" name="bio" rows="3" disabled>{{ profile.bio }}</textarea>
            </div>
        </div>

    </fieldset>
</form>

{# Output existing data as safely-escaped JSON for client-side population #}
<script id="initialSkills" type="application/json">{{ skills_json|safe }}</script>
<script id="initialPortfolio" type="application/json">{{ portfolio_json|safe }}</script>

<!-- SKILLS -->
<div class="profile-skills">
    <fieldset>
        <legend><strong><i class="fa-solid fa-lightbulb"></i> Skills</strong></legend>
        <div class="skills-desc">Add skills that showcase your expertise to potential organizations.</div>
        <div class="skills-list" id="skillsList"></div>

        <div id="skillInputWrap" style="display:none; margin-top:10px;">
            <input type="text" id="newSkill" placeholder="Add a skill..." />
            <button type="button" id="addSkillBtn" class="skill-add-btn">+</button>
        </div>
    </fieldset>
</div>


<!-- PORTFOLIO EDIT BLOCK -->
<div id="portfolioLinkEditBlock" style="display:none;">
    <fieldset class="portfolio-fieldset">
        <legend><strong><i class="fa-solid fa-link"></i> Add Portfolio Link</strong></legend>

        <div class="portfolio-form-row">
            <input type="text" id="portfolioName" class="portfolio-input" placeholder="Link name (e.g. GitHub)" />
            <input type="url" id="portfolioURL" class="portfolio-input" placeholder="URL" />
            <button type="button" id="addLinkBtn" class="portfolio-add-btn">Add Link</button>
        </div>

        <div id="portfolioLinksEdit" style="margin-top:16px;"></div>
    </fieldset>
</div>

        </section>
    </div>
</main>


<!-- SCRIPT FIXED VERSION -->
<script>
document.addEventListener("DOMContentLoaded", function () {

    /* EDIT / SAVE HANDLING */
    const editBtn = document.getElementById("editBtn");
    const saveBtn = document.getElementById("saveBtn");
    const inputs = document.querySelectorAll(".profile-form input, .profile-form textarea");
    const skillInputWrap = document.getElementById("skillInputWrap");
    const portfolioBlock = document.getElementById("portfolioLinkEditBlock");
    let isEditing = false;

    editBtn.addEventListener("click", () => {
        inputs.forEach(i => i.disabled = false);
        document.getElementById("profile_picture").disabled = false;
        document.getElementById("profilePictureWrapper").style.display = "block";

        editBtn.style.display = "none";
        saveBtn.style.display = "inline-block";

        skillInputWrap.style.display = "flex";
        portfolioBlock.style.display = "block";

        // Enter edit mode: show remove controls for skills and portfolio
        isEditing = true;
        document.querySelectorAll('.remove-skill').forEach(b => b.style.display = 'inline-block');
        document.querySelectorAll('.remove-link').forEach(b => b.style.display = 'inline-block');
    });

    // When Save is clicked: serialize skills and portfolio links into hidden inputs, then submit
    saveBtn.addEventListener("click", () => {
        // collect skills
        const skills = Array.from(skillsList.querySelectorAll('.skill-item')).map(el => {
            // stored in data-skill when added, otherwise use textContent
            return el.dataset.skill || el.textContent.replace('Ã—','').trim();
        });
        document.getElementById('skillsInput').value = JSON.stringify(skills);

        // collect portfolio links from edit area (each .portfolio-link may have data attrs)
        const portfolio = Array.from(portfolioLinksEdit.querySelectorAll('.portfolio-link')).map(el => ({
            name: el.dataset.name || (el.querySelector('a') ? el.querySelector('a').textContent.trim() : ''),
            url: el.dataset.url || (el.querySelector('a') ? el.querySelector('a').href : '')
        }));
        document.getElementById('portfolioInput').value = JSON.stringify(portfolio);

        document.querySelector('.profile-form').submit();
    });

    /* SKILLS MANAGEMENT */
    const skillsList = document.getElementById("skillsList");
    const addSkillBtn = document.getElementById("addSkillBtn");
    const newSkill = document.getElementById("newSkill");

    // Populate existing skills from server JSON
    try {
        const existingSkills = JSON.parse(document.getElementById('initialSkills').textContent || '[]');
        existingSkills.forEach(s => {
            if (!s) return;
            const skillDiv = document.createElement('div');
            skillDiv.classList.add('skill-item');
            skillDiv.textContent = s;
            skillDiv.dataset.skill = s;

            const removeBtn = document.createElement('span');
            removeBtn.classList.add('remove-skill');
            removeBtn.textContent = 'Ã—';
            // hide remove control until edit mode
            removeBtn.style.display = 'none';
            removeBtn.onclick = () => { if (isEditing) skillDiv.remove(); };

            skillDiv.appendChild(removeBtn);
            skillsList.appendChild(skillDiv);
        });
    } catch (e) { console.warn('Failed to parse initial skills', e); }

    addSkillBtn.addEventListener("click", () => {
        const skill = newSkill.value.trim();
        if (skill) {
            const skillDiv = document.createElement("div");
            skillDiv.classList.add("skill-item");
            skillDiv.textContent = skill;
            skillDiv.dataset.skill = skill;

            const removeBtn = document.createElement("span");
            removeBtn.classList.add("remove-skill");
            removeBtn.textContent = "Ã—";
            // removal only allowed in edit mode
            removeBtn.style.display = isEditing ? 'inline-block' : 'none';
            removeBtn.onclick = () => { if (isEditing) skillDiv.remove(); };

            skillDiv.appendChild(removeBtn);
            skillsList.appendChild(skillDiv);
            newSkill.value = "";

            // Send updated skills to server immediately (AJAX)
            try {
                const currentSkills = Array.from(skillsList.querySelectorAll('.skill-item')).map(el => el.dataset.skill || el.textContent.replace('Ã—','').trim());
                const csrftoken = (function(){
                    const name = 'csrftoken=';
                    const cookies = document.cookie.split(';');
                    for (let c of cookies) {
                        c = c.trim(); if (c.startsWith(name)) return decodeURIComponent(c.slice(name.length));
                    }
                    return '';
                })();

                fetch("{% url 'save_skills' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken
                    },
                    body: JSON.stringify({skills: currentSkills})
                }).then(r => r.json()).then(data => {
                    if (!data.success) console.warn('Failed to save skills', data);
                }).catch(err => console.error('Save skills error', err));
            } catch (e) { console.warn('Auto-save skills failed', e); }
        }
    });

    // Allow pressing Enter to add skill
    newSkill.addEventListener('keydown', function(e){
        if (e.key === 'Enter'){
            e.preventDefault();
            addSkillBtn.click();
        }
    });

    /* PORTFOLIO LINKS */
    const addLinkBtn = document.getElementById("addLinkBtn");
    const portfolioName = document.getElementById("portfolioName");
    const portfolioURL = document.getElementById("portfolioURL");
    const linksListView = document.getElementById("linksListView");
    const portfolioLinksEdit = document.getElementById("portfolioLinksEdit");

    // Populate existing portfolio links from server JSON
    try {
        const existingPortfolio = JSON.parse(document.getElementById('initialPortfolio').textContent || '[]');
        existingPortfolio.forEach(item => {
            if (!item || !item.name || !item.url) return;
            const viewLink = document.createElement('div');
            viewLink.classList.add('portfolio-link');
            viewLink.innerHTML = `<a href="${item.url}" target="_blank">${item.name}</a>`;
            linksListView.appendChild(viewLink);

            const editLink = document.createElement('div');
            editLink.classList.add('portfolio-link');
            editLink.innerHTML = `\n                <a href="${item.url}" target="_blank">${item.name}</a>\n                <button type="button" class="remove-link" style="margin-left:8px;color:#dc2626;background:none;border:none;font-weight:bold;cursor:pointer;">Ã—</button>\n            `;
            // hide remove until edit mode; removal only allowed when editing
            const removeBtn = editLink.querySelector('.remove-link');
            removeBtn.style.display = 'none';
            removeBtn.onclick = () => { if (isEditing) editLink.remove(); };
            editLink.dataset.name = item.name;
            editLink.dataset.url = item.url;
            portfolioLinksEdit.appendChild(editLink);
        });
    } catch (e) { console.warn('Failed to parse initial portfolio', e); }

    addLinkBtn.addEventListener("click", () => {
        const name = portfolioName.value.trim();
        const url = portfolioURL.value.trim();

        if (name && url) {
            // view mode
            const viewLink = document.createElement("div");
            viewLink.classList.add("portfolio-link");
            viewLink.innerHTML = `<a href="${url}" target="_blank">${name}</a>`;
            linksListView.appendChild(viewLink);

            // edit mode
            const editLink = document.createElement("div");
            editLink.classList.add("portfolio-link");
            editLink.innerHTML = `
                <a href="${url}" target="_blank">${name}</a>
                <button type="button" class="remove-link"
                    style="margin-left:8px;color:#dc2626;background:none;border:none;font-weight:bold;cursor:pointer;">Ã—
                </button>
            `;
            editLink.querySelector(".remove-link").onclick = () => editLink.remove();
            // store values so we can serialize later
            editLink.dataset.name = name;
            editLink.dataset.url = url;
            portfolioLinksEdit.appendChild(editLink);

            portfolioName.value = "";
            portfolioURL.value = "";
        }
    });

    /* PROFILE AVATAR DROPDOWN â€” CORRECT VERSION */
    const avatar = document.getElementById("profileAvatar");
    const menu = document.getElementById("profileMenu");

    avatar.addEventListener("click", (event) => {
        event.stopPropagation();
        menu.parentElement.classList.toggle("show"); // correct behavior
    });

    document.addEventListener("click", (event) => {
        if (!menu.contains(event.target) && !avatar.contains(event.target)) {
            menu.parentElement.classList.remove("show");
        }
    });

});
</script>

  <!-- Include the error message component JavaScript -->
  <script src="{% static 'Myapp/error_message.js' %}"></script>

</body>
</html>
