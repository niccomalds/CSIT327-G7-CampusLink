{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>CampusLink - Organization Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Manage your organization's opportunities and connect with student talent">
  
  <!-- External Dependencies -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" crossorigin="anonymous">
  
  <!-- Application Stylesheets -->
  <link rel="stylesheet" href="{% static 'Myapp/org_dashboard.css' %}?v=1.3">
  <link rel="stylesheet" href="{% static 'Myapp/error_message.css' %}?v=1.1">
  <link rel="stylesheet" href="{% static 'Myapp/components/verification_modal.css' %}?v=1.0">
</head>

<body>
  <!-- Global Notification Area -->
  <div class="alert-container" role="alert" aria-live="polite"></div>
  
  <!-- Primary Navigation -->
  <header class="header" role="banner">
    <div class="logo">
      <i class="fa-solid fa-graduation-cap" aria-hidden="true"></i>
      <span>CampusLink</span>
    </div>

    <nav class="main-nav" role="navigation" aria-label="Main navigation">
      <a href="{% url 'organization_dashboard' %}" class="active" aria-current="page">
        <i class="fa-solid fa-gauge-high" aria-hidden="true"></i>
        Dashboard
      </a>
      <a href="{% url 'post_opportunity' %}">
        <i class="fa-solid fa-plus-circle" aria-hidden="true"></i>
        Post Opportunity
      </a>
      <a href="{% url 'manage_postings' %}">
        <i class="fa-solid fa-users" aria-hidden="true"></i>
        Applicants
      </a>
      <a href="{% url 'org_profile' %}">
        <i class="fa-solid fa-user-gear" aria-hidden="true"></i>
        Profile
      </a>
    </nav>

    <!-- User Controls -->
    <div class="user-controls">
      <!-- Notifications -->
      <div class="notification-wrapper">
        <a href="{% url 'notifications' %}" 
           id="notifBell" 
           class="notif-bell"
           aria-label="Notifications"
           {% if unread_count > 0 %}aria-describedby="unread-notifications"{% endif %}>
          <i class="fa-solid fa-bell" aria-hidden="true"></i>
          {% if unread_count > 0 %}
            <span class="notif-badge" id="unread-notifications">{{ unread_count }}</span>
          {% endif %}
        </a>
      </div>

      <!-- Profile Dropdown -->
      <div class="profile-dropdown" id="orgProfileDropdown">
        <button class="avatar-button" id="profileAvatar" aria-label="Profile menu" aria-expanded="false">
          <img src="{% if user.profile.profile_picture %}
                      {{ user.profile.profile_picture.url }}
                   {% else %}
                      /static/Myapp/default-avatar.png
                   {% endif %}"
               alt="{{ user.get_full_name|default:user.email }}"
               class="avatar">
        </button>

        <div class="dropdown-menu" id="orgDropdownMenu" role="menu" aria-labelledby="profileAvatar">
          <div class="dropdown-header">
            <i class="fa-solid fa-building" aria-hidden="true"></i>
            Organization Account
          </div>
          <a href="{% url 'org_profile' %}" role="menuitem">
            <i class="fa-solid fa-user" aria-hidden="true"></i>
            Profile & Settings
          </a>
          <a href="{% url 'logout' %}" role="menuitem" class="logout-item">
            <i class="fa-solid fa-right-from-bracket" aria-hidden="true"></i>
            Log out
          </a>
        </div>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="dashboard-main" role="main">
    <!-- Verification Modal (Conditional) -->
    {% if needs_verification %}
    <div class="verification-overlay" id="verificationOverlay" role="dialog" aria-modal="true" aria-labelledby="verification-title">
      <div class="verification-modal">
        <button class="close-btn" onclick="closeVerificationModal()" aria-label="Close verification dialog">
          <i class="fa-solid fa-xmark" aria-hidden="true"></i>
        </button>
        
        <div class="modal-header">
          <div class="modal-icon" aria-hidden="true">üîç</div>
          <h3 id="verification-title">Organization Verification Required</h3>
          <p class="modal-subtitle">To unlock all features and post opportunities, please verify your organization.</p>
        </div>

        <div class="requirements">
          <h4>Required for Verification:</h4>
          <ul class="requirements-list">
            <li>
              <i class="fa-solid fa-envelope" aria-hidden="true"></i>
              <strong>Institutional Email:</strong> Official email address (.edu, .ac, .org domains)
            </li>
            <li>
              <i class="fa-solid fa-file-contract" aria-hidden="true"></i>
              <strong>Verification Documents:</strong> Official documents proving organization status
            </li>
            <li>
              <i class="fa-solid fa-clock" aria-hidden="true"></i>
              <strong>Processing Time:</strong> Typically 1-2 business days
            </li>
          </ul>
          
          <div class="verification-note">
            <i class="fa-solid fa-circle-info" aria-hidden="true"></i>
            <p>Note: You must be verified to post opportunities. Complete verification to unlock all features.</p>
          </div>
        </div>

        <div class="modal-actions">
          <a href="{% url 'submit_verification' %}" class="verify-btn">
            <i class="fa-solid fa-shield-check" aria-hidden="true"></i>
            Start Verification Process
          </a>
          <button class="secondary-btn" onclick="closeVerificationModal()">
            Continue to Dashboard
          </button>
        </div>
      </div>
    </div>
    
    {% elif is_pending %}
    <div class="verification-overlay" id="verificationOverlay" role="dialog" aria-modal="true" aria-labelledby="pending-title">
      <div class="verification-modal">
        <div class="modal-header">
          <div class="modal-icon" aria-hidden="true">‚è≥</div>
          <h3 id="pending-title">Verification Under Review</h3>
          <p class="modal-subtitle">Your verification request is being processed. We'll notify you once complete.</p>
        </div>
        
        {% if profile.verification_submitted_at %}
        <div class="requirements">
          <div class="submission-details">
            <div class="detail-item">
              <i class="fa-solid fa-calendar-check" aria-hidden="true"></i>
              <div>
                <span class="detail-label">Submitted on:</span>
                <span class="detail-value">{{ profile.verification_submitted_at|date:"F d, Y" }}</span>
              </div>
            </div>
            
            <div class="detail-item">
              <i class="fa-solid fa-hourglass-half" aria-hidden="true"></i>
              <div>
                <span class="detail-label">Status:</span>
                <span class="status-badge pending">Pending Review</span>
              </div>
            </div>
          </div>
          
          <div class="verification-note">
            <i class="fa-solid fa-circle-info" aria-hidden="true"></i>
            <p>Thank you for your patience. You'll receive an email notification once verification is complete.</p>
          </div>
        </div>
        {% endif %}

        <div class="modal-actions single-action">
          <button class="primary-btn" onclick="closeVerificationModal()">
            Continue to Dashboard
          </button>
        </div>
      </div>
    </div>
    {% endif %}

    <!-- Dashboard Header -->
    <div class="dashboard-header">
      <div class="header-content">
        <h1 class="dashboard-title">
          Organization <span class="highlight">Dashboard</span>
        </h1>
        <p class="dashboard-subtitle">Manage your opportunities and connect with talented students.</p>
        
        <div class="quick-stats">
          <div class="stat-pill">
            <i class="fa-solid fa-building" aria-hidden="true"></i>
            <span>{{ profile.org_name|default:"Organization" }}</span>
          </div>
          <div class="stat-pill">
            <i class="fa-solid fa-user-check" aria-hidden="true"></i>
            <span>{{ total_applicants }} Total Applicants</span>
          </div>
        </div>
      </div>
      
      <div class="header-actions">
        <a href="{% url 'post_opportunity' %}" class="action-button primary">
          <i class="fa-solid fa-plus" aria-hidden="true"></i>
          Post New Opportunity
        </a>
        <button class="action-button secondary" onclick="refreshDashboard()">
          <i class="fa-solid fa-arrows-rotate" aria-hidden="true"></i>
          Refresh
        </button>
      </div>
    </div>

    <!-- Statistics Overview -->
    <section class="stats-section" aria-label="Organization statistics">
      <div class="stat-card">
        <div class="stat-icon">
          <i class="fa-solid fa-bullhorn" aria-hidden="true"></i>
        </div>
        <div class="stat-content">
          <div class="stat-value">{{ active_postings_count }}</div>
          <div class="stat-label">Active Postings</div>
          <div class="stat-trend positive">
            <i class="fa-solid fa-arrow-up" aria-hidden="true"></i>
            <span>+2 from last month</span>
          </div>
        </div>
      </div>

      {% if not is_verified %}
      <div class="stat-card verification-alert" onclick="openVerificationModal()" 
           role="button" tabindex="0" aria-label="Verification required - click to view details">
        <div class="stat-icon">
          <i class="fa-solid fa-shield-exclamation" aria-hidden="true"></i>
        </div>
        <div class="stat-content">
          <div class="stat-value">Verification Required</div>
          <div class="stat-label">Account Status</div>
          <div class="stat-trend warning">
            <i class="fa-solid fa-exclamation-circle" aria-hidden="true"></i>
            <span>Click to verify</span>
          </div>
        </div>
      </div>
      {% endif %}

      <div class="stat-card">
        <div class="stat-icon">
          <i class="fa-solid fa-user-graduate" aria-hidden="true"></i>
        </div>
        <div class="stat-content">
          <div class="stat-value">{{ total_applicants }}</div>
          <div class="stat-label">Total Applicants</div>
          <div class="stat-trend positive">
            <i class="fa-solid fa-arrow-up" aria-hidden="true"></i>
            <span>+12% from last week</span>
          </div>
        </div>
      </div>
    </section>

    <!-- Recent Postings Section -->
    <section class="content-section" aria-label="Recent opportunities">
      <div class="section-header">
        <div class="section-title">
          <i class="fa-solid fa-briefcase" aria-hidden="true"></i>
          <h2>Recent Opportunities</h2>
        </div>
        <div class="section-actions">
          <a href="{% url 'manage_postings' %}" class="view-all-link">
            View All Postings
            <i class="fa-solid fa-arrow-right" aria-hidden="true"></i>
          </a>
        </div>
      </div>

      <!-- Opportunities Grid -->
      <div class="opportunity-grid">
        {% for posting in recent_postings %}
        <article class="opportunity-card" role="article">
          <div class="card-header">
            <h3 class="opportunity-title">{{ posting.title }}</h3>
            <div class="opportunity-meta">
              <span class="org-name">
                <i class="fa-solid fa-building" aria-hidden="true"></i>
                {{ profile.org_name|default:user.email }}
              </span>
              <span class="status-badge {{ posting.opportunity_type }}">
                {{ posting.get_opportunity_type_display }}
              </span>
            </div>
          </div>
          
          <div class="card-body">
            <p class="opportunity-description">{{ posting.description|truncatewords:30 }}</p>
            
            {% if posting.tags.exists %}
            <div class="tag-list" aria-label="Skills required">
              {% for tag in posting.tags.all|slice:":3" %}
              <span class="tag">{{ tag.name }}</span>
              {% endfor %}
              {% if posting.tags.count > 3 %}
              <span class="tag-more">+{{ posting.tags.count|add:"-3" }} more</span>
              {% endif %}
            </div>
            {% endif %}
          </div>
          
          <div class="card-footer">
            <div class="footer-details">
              <div class="detail-item">
                <i class="fa-solid fa-users" aria-hidden="true"></i>
                <span>{{ posting.applications.count }} applicants</span>
              </div>
              <div class="detail-item">
                <i class="fa-solid fa-calendar-day" aria-hidden="true"></i>
                <span>Due {{ posting.deadline|date:"M d" }}</span>
              </div>
            </div>
            <a href="{% url 'opportunity_detail' posting.id %}" class="view-details-btn">
              View Details
              <i class="fa-solid fa-chevron-right" aria-hidden="true"></i>
            </a>
          </div>
        </article>
        {% empty %}
        <!-- Empty State -->
        <div class="empty-state" role="status">
          <div class="empty-state-icon">
            <i class="fa-solid fa-inbox" aria-hidden="true"></i>
          </div>
          <h3>No Opportunities Posted Yet</h3>
          <p>You haven't created any opportunities yet. Start by posting your first opportunity to connect with student talent.</p>
          <div class="empty-state-actions">
            <a href="{% url 'post_opportunity' %}" class="primary-btn">
              <i class="fa-solid fa-plus" aria-hidden="true"></i>
              Post Your First Opportunity
            </a>
          </div>
          <div class="empty-state-tip">
            <i class="fa-solid fa-lightbulb" aria-hidden="true"></i>
            <span>Tip: Include clear requirements and responsibilities to attract quality candidates.</span>
          </div>
        </div>
        {% endfor %}
      </div>
    </section>
  </main>

  <!-- Verification Banner (Non-intrusive reminder) -->
  {% if not is_verified and not is_pending %}
  <aside class="verification-banner" id="verificationBanner" role="complementary" aria-label="Verification reminder">
    <div class="banner-content">
      <div class="banner-message">
        <i class="fa-solid fa-shield-check" aria-hidden="true"></i>
        <div>
          <strong>Complete verification to unlock all features</strong>
          <span>Post opportunities and access premium features</span>
        </div>
      </div>
      <div class="banner-actions">
        <button class="banner-btn primary" onclick="openVerificationModal()">Verify Now</button>
        <button class="banner-btn secondary" onclick="closeBanner()">Dismiss</button>
      </div>
    </div>
  </aside>
  {% endif %}

  <!-- JavaScript Modules -->
  <script>
    'use strict';

    // ===================== MODULE: Dashboard Interactions =====================
    const Dashboard = (function() {
      // Initialize dashboard components
      function init() {
        animateProgressBars();
        setupEventListeners();
        loadPerformanceMetrics();
      }

      // Animate progress indicators
      function animateProgressBars() {
        document.querySelectorAll('.bar-fill').forEach(bar => {
          const targetWidth = parseInt(bar.dataset.target) || 0;
          let currentWidth = 0;
          
          const animate = () => {
            if (currentWidth < targetWidth) {
              currentWidth += 2;
              bar.style.width = `${currentWidth}%`;
              requestAnimationFrame(animate);
            }
          };
          
          setTimeout(animate, 350);
        });
      }

      // Load performance data
      function loadPerformanceMetrics() {
        // Could be expanded to fetch real-time metrics via AJAX
        console.log('Loading dashboard metrics...');
      }

      // Refresh dashboard data
      function refreshDashboard() {
        const refreshBtn = document.querySelector('[onclick="refreshDashboard()"]');
        if (refreshBtn) {
          refreshBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Refreshing...';
          refreshBtn.disabled = true;
          
          setTimeout(() => {
            location.reload();
          }, 1000);
        }
      }

      // Set up event listeners
      function setupEventListeners() {
        // Profile dropdown
        const profileAvatar = document.getElementById('profileAvatar');
        const dropdownMenu = document.getElementById('orgDropdownMenu');
        
        if (profileAvatar && dropdownMenu) {
          profileAvatar.addEventListener('click', (e) => {
            e.stopPropagation();
            const isExpanded = profileAvatar.getAttribute('aria-expanded') === 'true';
            profileAvatar.setAttribute('aria-expanded', !isExpanded);
            dropdownMenu.style.display = isExpanded ? 'none' : 'flex';
          });

          // Close dropdown when clicking outside
          document.addEventListener('click', (e) => {
            if (!e.target.closest('.profile-dropdown')) {
              profileAvatar.setAttribute('aria-expanded', 'false');
              dropdownMenu.style.display = 'none';
            }
          });
        }
      }

      return {
        init,
        refresh: refreshDashboard
      };
    })();

    // ===================== MODULE: Verification Modal =====================
    const VerificationModal = (function() {
      let isOpen = false;

      function open() {
        const overlay = document.getElementById('verificationOverlay');
        if (overlay) {
          overlay.style.display = 'flex';
          setTimeout(() => {
            overlay.style.opacity = '1';
            overlay.setAttribute('aria-hidden', 'false');
            isOpen = true;
            
            // Focus trap for accessibility
            const closeBtn = overlay.querySelector('.close-btn, .primary-btn');
            if (closeBtn) closeBtn.focus();
          }, 10);
        }
      }

      function close() {
        const overlay = document.getElementById('verificationOverlay');
        if (overlay) {
          overlay.style.opacity = '0';
          setTimeout(() => {
            overlay.style.display = 'none';
            overlay.setAttribute('aria-hidden', 'true');
            isOpen = false;
          }, 300);
        }
      }

      // Handle Escape key
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && isOpen) {
          close();
        }
      });

      // Close on overlay click
      document.addEventListener('click', (e) => {
        const overlay = document.getElementById('verificationOverlay');
        if (overlay && e.target === overlay && isOpen) {
          close();
        }
      });

      return {
        open,
        close
      };
    })();

    // ===================== MODULE: Banner Management =====================
    const BannerManager = (function() {
      function closeBanner() {
        const banner = document.getElementById('verificationBanner');
        if (banner) {
          banner.style.transform = 'translateY(100%)';
          banner.style.opacity = '0';
          
          setTimeout(() => {
            banner.style.display = 'none';
            
            // Store dismissal in session storage
            sessionStorage.setItem('bannerDismissed', 'true');
          }, 300);
        }
      }

      // Check if banner should be shown
      function shouldShowBanner() {
        return sessionStorage.getItem('bannerDismissed') !== 'true';
      }

      // Initialize banner state
      function init() {
        const banner = document.getElementById('verificationBanner');
        if (banner && shouldShowBanner()) {
          setTimeout(() => {
            banner.style.display = 'flex';
            setTimeout(() => {
              banner.style.transform = 'translateY(0)';
              banner.style.opacity = '1';
            }, 100);
          }, 2000); // Show after 2 seconds
        }
      }

      return {
        close: closeBanner,
        init
      };
    })();

    // ===================== INITIALIZATION =====================
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize dashboard
      Dashboard.init();
      
      // Initialize banner if present
      BannerManager.init();
      
      // Make notifications clickable
      document.querySelectorAll('.notif-item').forEach(item => {
        item.addEventListener('click', function() {
          const notifId = this.dataset.notifId;
          if (notifId) {
            window.location.href = `{% url 'notifications' %}#notification-${notifId}`;
          }
        });
      });
      
      // Add loading states to buttons
      document.querySelectorAll('a.action-button').forEach(button => {
        button.addEventListener('click', function(e) {
          if (this.href === '#' || !this.classList.contains('primary')) return;
          
          this.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Processing...';
          this.disabled = true;
        });
      });
    });

    // ===================== GLOBAL FUNCTIONS =====================
    // Expose functions to global scope for inline handlers
    window.openVerificationModal = VerificationModal.open;
    window.closeVerificationModal = VerificationModal.close;
    window.closeBanner = BannerManager.close;
    window.refreshDashboard = Dashboard.refresh;
  </script>

  <!-- Error handling module -->
  <script src="{% static 'Myapp/error_message.js' %}?v=1.2" defer></script>
  
  <!-- Performance monitoring -->
  <script>
    // Track page load performance
    window.addEventListener('load', function() {
      const loadTime = performance.timing.loadEventEnd - performance.timing.navigationStart;
      console.log(`Dashboard loaded in ${loadTime}ms`);
    });
  </script>

</body>
</html>