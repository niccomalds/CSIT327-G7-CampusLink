{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CampusLink â€“ Student Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="{% static 'Myapp/student_dashboard.css' %}?v=3.5">
  <link rel="stylesheet" href="{% static 'Myapp/main.css' %}">
  <!-- Include the error message component CSS -->
  <link rel="stylesheet" href="{% static 'Myapp/error_message.css' %}">
  
</head>
<body>
  <!-- Alert container for global error messages -->
  <div class="alert-container"></div>
  
  <!-- Application Modal -->
  <div id="applicationModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2><i class="fa-solid fa-file-arrow-up"></i> Apply for Opportunity</h2>
        <button class="close-modal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="posting-preview">
          <h3 id="modalPostingTitle">Opportunity Title</h3>
          <p id="modalPostingDescription">Opportunity description will appear here...</p>
          <div class="posting-details">
            <span class="detail-item"><i class="fa-solid fa-calendar"></i> Deadline: <span id="modalPostingDeadline">Dec 31, 2023</span></span>
            <span class="detail-item"><i class="fa-solid fa-tag"></i> <span id="modalPostingType">Type</span></span>
            <span class="detail-item"><i class="fa-solid fa-building"></i> <span id="modalPostingOrg">Organization</span></span>
          </div>
        </div>
        
        <form id="applicationForm" method="POST" enctype="multipart/form-data">
          {% csrf_token %}
          <input type="hidden" id="postingId" name="posting_id" value="">
          
          <!-- Resume Upload Section -->
          <div class="form-section">
            <h3><i class="fa-solid fa-file-pdf"></i> Resume/CV * <span class="help-text-inline">Required. Accepted formats: PDF, DOC, DOCX. Maximum file size: 5MB.</span></h3>
            <div class="form-group">
              <div class="file-upload" id="resumeDropArea">
                <i class="fa-solid fa-cloud-arrow-up"></i>
                <p>Drag & drop your resume here or click to browse</p>
                <input type="file" id="resume" name="resume" class="file-input" accept=".pdf,.doc,.docx" required>
                <label for="resume" class="file-label">Choose File</label>
                <div class="file-name" id="resumeFileName">No file chosen</div>
              </div>
            </div>
          </div>

          <!-- Personal Note Section -->
          <div class="form-section">
            <h3><i class="fa-solid fa-comment"></i> Personal Note</h3>
            <div class="form-group">
              <textarea id="note" name="note" placeholder="Tell us about your interest, relevant experience, and what you hope to gain from this opportunity..."></textarea>
            </div>
          </div>

          <!-- Additional Attachments Section -->
          <div class="form-section">
            <h3><i class="fa-solid fa-paperclip"></i> Additional Attachments (Optional)</h3>
            <div class="form-group">
              <div class="file-upload" id="attachmentsDropArea">
                <i class="fa-solid fa-folder-open"></i>
                <p>Drag & drop additional files here or click to browse</p>
                <input type="file" id="attachments" name="attachments" class="file-input" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" multiple>
                <label for="attachments" class="file-label">Choose Files</label>
                <div class="file-name" id="attachmentsFileName">No files chosen</div>
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="cancelApplication">Cancel</button>
        <button class="btn btn-primary" id="submitApplication">
          <i class="fa-solid fa-paper-plane"></i> Submit Application
        </button>
      </div>
    </div>
  </div>
  
  <!-- Application Success Modal -->
  <div class="application-success-overlay" id="applicationSuccessOverlay">
    <div class="application-success-modal">
      <div class="modal-header">
        <div class="modal-icon">âœ…</div>
        <h3>Application Submitted!</h3>
        <p>Your application has been successfully sent</p>
      </div>
      
      <div class="success-message">
        <p>Thank you for submitting your application. The organization will review your application and you'll be notified of any updates. You can view all your applications in the "My Applications" section.</p>
      </div>
      
      <div class="modal-actions">
        <button class="btn-success" onclick="closeApplicationSuccessModal()">
          Continue Browsing
        </button>
        <a href="{% url 'my_applications' %}" class="btn-success">
          View Applications
        </a>
      </div>
    </div>
  </div>

  <header class="sticky top-0 z-40 bg-white">
    <!-- full-width header background; inner container centers content -->
    <div class="w-full left-0 right-0 shadow-[0_4px_12px_rgba(0,0,0,0.08)]">
        <div class="max-w-[1400px] mx-auto w-full flex items-center justify-between px-12 py-4 rounded-b-[16px] ">

            <div class="logo flex items-center gap-3 text-[#00c6ff]">
                <i class="fa-solid fa-graduation-cap text-2xl"></i>
                <span class="text-2xl font-extrabold">CampusLink</span>
            </div>

            <nav class="flex items-center">
                <a href="{% url 'student_dashboard' %}" class="text-gray-600 font-medium text-base pb-1 border-b-2 border-transparent hover:text-[#00c6ff] hover:border-[#00c6ff] active">Home</a>
                <a href="{% url 'my_applications' %}"   class="text-gray-600 font-medium text-base pb-1 border-b-2 border-transparent hover:text-[#00c6ff] hover:border-[#00c6ff]">My Applications</a>
                <a href="{% url 'profile' %}"           class="text-gray-600 font-medium text-base pb-1 border-b-2 border-transparent">Profile</a>
            </nav>

            <div class="search-profile flex items-center gap-4">

                <!-- ðŸ”” NOTIFICATION BELL -->
                <div class="notification-wrapper relative">
                    <a href="{% url 'student_notification' %}" id="notifBell" class="notif-bell text-gray-600 hover:text-[#00c6ff] relative">
                        <i class="fa-solid fa-bell"></i>
                        {% if unread_count > 0 %}
                        <span class="notif-badge">{{ unread_count }}</span>
                        {% endif %}
                    </a>
                </div>

                <!-- PROFILE DROPDOWN -->
                <div class="profile-dropdown">
                    <img src="{% if user.profile.profile_picture %}{{ user.profile.profile_picture.url }}{% else %}{% static 'Myapp/default-avatar.png' %}{% endif %}"
                             alt="Profile"
                             class="avatar"
                             id="profileAvatar">

                    <div class="dropdown-menu" id="profileMenu">
                        <div class="dropdown-header">Student</div>

                        <a href="{% url 'profile' %}">
                            <i class="fa-solid fa-user"></i> Profile
                        </a>

                        <a href="{% url 'logout' %}">
                            <i class="fa-solid fa-right-from-bracket"></i> Log out
                        </a>
                    </div>
                </div>

            </div>

        </div>
    </div>
</header>
  <main>
    <div class="dashboard-title">
      <h1>Discover Your Next <span class="highlight">Opportunity</span></h1>
      <p>Explore internships, research positions, and part-time jobs tailored for your academic journey.</p>
    </div>
    <section class="stats-row">
  <div class="stat-card">
    <span class="stat-num">{{ active_opportunities_count }}</span>
    <span class="stat-label">Active Opportunities</span>
  </div>

  <div class="stat-card">
    <span class="stat-num">{{ students_connected_count }}</span>
    <span class="stat-label">Students Connected</span>
  </div>

  <div class="stat-card">
    <span class="stat-num">1</span>
    <span class="stat-label">Applications Pending</span>
  </div>
</section>

    <section class="search-filter-row">
  <div class="search-controls-group">
    <div class="search-box">
      <i class="fa-solid fa-magnifying-glass"></i>
      <input type="text" placeholder="Search by title, organization, or skills..." />
    </div>
    
    <select class="filter-dropdown" id="sortDropdown">
      <option value="recent">Most Recent</option>
      <option value="deadline">Deadline Soonest</option>
      <option value="organization">Organization A-Z</option>
      <option value="title">Title A-Z</option>
    </select>

    <select class="filter-dropdown" id="deadlineFilter">
      <option value="">All Deadlines</option>
      <option value="today">Due Today</option>
      <option value="week">Due This Week</option>
      <option value="month">Due This Month</option>
      <option value="custom">Custom Range</option>
    </select>
    
    <div class="type-filter-inline">
      <span class="filter-label">Type:</span>
      <div class="type-filter-options-inline">
        <label class="type-checkbox-inline">
  <input type="checkbox" class="type-option" name="opportunityType" value="assistantship">
  <span class="checkmark-inline"></span>
  <span class="type-label-inline">Assistantship</span>
</label>

<label class="type-checkbox-inline">
  <input type="checkbox" class="type-option" name="opportunityType" value="volunteer">
  <span class="checkmark-inline"></span>
  <span class="type-label-inline">Volunteer</span>
</label>

<label class="type-checkbox-inline">
  <input type="checkbox" class="type-option" name="opportunityType" value="internship">
  <span class="checkmark-inline"></span>
  <span class="type-label-inline">Internship</span>
</label>

<label class="type-checkbox-inline">
  <input type="checkbox" class="type-option" name="opportunityType" value="job">
  <span class="checkmark-inline"></span>
  <span class="type-label-inline">Job</span>
</label>

<label class="type-checkbox-inline">
  <input type="checkbox" class="type-option" name="opportunityType" value="scholarship">
  <span class="checkmark-inline"></span>
  <span class="type-label-inline">Scholarship</span>
</label>

<label class="type-checkbox-inline">
  <input type="checkbox" class="type-option" name="opportunityType" value="events">
  <span class="checkmark-inline"></span>
  <span class="type-label-inline">Events</span>
</label>

<label class="type-checkbox-inline">
  <input type="checkbox" class="type-option" name="opportunityType" value="sports">
  <span class="checkmark-inline"></span>
  <span class="type-label-inline">Sports</span>
</label>

<label class="type-checkbox-inline">
  <input type="checkbox" class="type-option" name="opportunityType" value="leadership">
  <span class="checkmark-inline"></span>
  <span class="type-label-inline">Leadership</span>
</label>

<label class="type-checkbox-inline">
  <input type="checkbox" class="type-option" name="opportunityType" value="other">
  <span class="checkmark-inline"></span>
  <span class="type-label-inline">Other</span>
</label>

      </div>
    </div>
  </div>

  <div class="filter-controls-group">
    <div class="custom-date-range" id="customDateRange" style="display: none;">
      <input type="date" id="startDate" class="date-input">
      <span>to</span>
      <input type="date" id="endDate" class="date-input">
      <button class="apply-custom-range">Apply</button>
    </div>
    <div class="search-results-info" id="searchResultsInfo">
      Showing <span id="resultsCount">0</span> results
    </div>
  </div>
</section>

    <!-- OPPORTUNITY GRID -->
<section class="opportunity-grid" id="opportunityGrid">
  {% for item in postings_list %}
  {% with posting=item.posting tags_list=item.tags_list has_applied=item.has_applied %}
  <div class="opp-card" data-deadline="{{ posting.deadline|date:'Y-m-d' }}" data-type="{{ posting.opportunity_type|default:'other' }}" data-posted="{{ posting.created_at|date:'Y-m-d' }}">
    <div class="opp-header">
      <h3>{{ posting.title }}</h3>
      <span class="opp-org">{{ posting.organization.profile.org_name|default:posting.organization.email }}</span>
    </div>
    <div class="opp-desc">{{ posting.description|truncatewords:20 }}</div>
    <div class="opp-tags">
      {% for tag in tags_list %}
        <span>{{ tag }}</span>
      {% endfor %}
    </div>
    <div class="opp-details">
      <span class="opp-type"><i class="fa-solid fa-briefcase"></i> {{ posting.get_opportunity_type_display }}</span>
      <span class="opp-applicants">0 applicants</span>
      <span class="opp-deadline"><i class="fa-solid fa-calendar"></i> Due: {{ posting.deadline|date:"M d, Y" }}</span>
      <span class="type-badge {{ posting.opportunity_type|default:'other' }}">{{ posting.get_opportunity_type_display|default:'Other' }}</span>
    </div>
    {% if has_applied %}
      <button class="apply-btn applied" disabled>
        <i class="fa-solid fa-check"></i> Applied
      </button>
    {% else %}
      <button class="apply-btn" onclick="openApplicationModal({{ posting.id }}, '{{ posting.title|escapejs }}', '{{ posting.description|escapejs }}', '{{ posting.deadline|date:"M d, Y"|escapejs }}', '{{ posting.get_opportunity_type_display|escapejs }}', '{{ posting.organization.profile.org_name|default:posting.organization.email|escapejs }}')">
        Apply Now
      </button>
    {% endif %}
  </div>
  {% endwith %}
  {% empty %}
  <div class="no-opportunities-message" style="display: block; grid-column: 1 / -1;">
    <i class="fa-solid fa-inbox"></i>
    <h3>No Current Opportunities Available</h3>
    <p>We don't have any active opportunities posted by organizations at the moment. Please check back later as new opportunities are regularly added. Organizations must be verified to post opportunities, ensuring quality and legitimacy of all listings.</p>
    <div class="no-results-tip">
      <i class="fa-solid fa-lightbulb"></i>
      <span>Tip: Check back weekly for new opportunities tailored to your interests!</span>
    </div>
  </div>
  {% endfor %}
</section>

    <div class="no-results" id="noResults">
      <i class="fa-solid fa-search"></i>
      <h3>No opportunities found</h3>
      <p>Try adjusting your search terms or filters</p>
    </div>
  </main>
  <script src="{% static 'Myapp/student_dashboard.js' %}?v=1.8"></script>
  <!-- Include the error message component JavaScript -->
  <script src="{% static 'Myapp/error_message.js' %}"></script>
  <script>
    document.querySelectorAll(".type-option").forEach(cb => {
  cb.addEventListener("change", function() {
    if (this.checked) {
      document.querySelectorAll(".type-option").forEach(other => {
        if (other !== this) other.checked = false;
      });
    }
  });
});
    // Display Django messages when the page loads
    document.addEventListener("DOMContentLoaded", function() {
      {% if messages %}
        {% for message in messages %}
          {% if message.tags == 'success' %}
            showSuccessMessage('Success', '{{ message }}');
          {% elif message.tags == 'error' %}
            showErrorMessage('Error', '{{ message }}');
          {% elif message.tags == 'warning' %}
            showWarningMessage('Warning', '{{ message }}');
          {% elif message.tags == 'info' %}
            showInfoMessage('Info', '{{ message }}');
          {% endif %}
        {% endfor %}
      {% endif %}
    });
    
    document.addEventListener("DOMContentLoaded", function() {
      /* ============================
         MODAL FUNCTIONALITY
      ============================ */
      const modal = document.getElementById('applicationModal');
      const closeModalBtn = document.querySelector('.close-modal');
      const cancelApplicationBtn = document.getElementById('cancelApplication');
      const submitApplicationBtn = document.getElementById('submitApplication');
      const applicationForm = document.getElementById('applicationForm');
      
      // Open modal with posting details
      function openApplicationModal(postingId, title, description, deadline, type, organization) {
        document.getElementById('postingId').value = postingId;
        document.getElementById('modalPostingTitle').textContent = title;
        document.getElementById('modalPostingDescription').textContent = description;
        document.getElementById('modalPostingDeadline').textContent = deadline;
        document.getElementById('modalPostingType').textContent = type;
        document.getElementById('modalPostingOrg').textContent = organization;
        
        modal.style.display = 'block';
        document.body.style.overflow = 'hidden'; // Prevent background scrolling
      }
      
      // Close modal
      function closeApplicationModal() {
        modal.style.display = 'none';
        document.body.style.overflow = 'auto'; // Re-enable scrolling
        // Reset form
        applicationForm.reset();
        document.getElementById('resumeFileName').textContent = 'No file chosen';
        document.getElementById('attachmentsFileName').textContent = 'No files chosen';
      }
      
      // Event listeners for closing modal
      if (closeModalBtn) closeModalBtn.addEventListener('click', closeApplicationModal);
      if (cancelApplicationBtn) cancelApplicationBtn.addEventListener('click', closeApplicationModal);
      
      // Close modal when clicking outside
      window.addEventListener('click', function(event) {
        if (event.target === modal) {
          closeApplicationModal();
        }
      });
      
      // Handle form submission
      if (submitApplicationBtn) {
        submitApplicationBtn.addEventListener('click', function() {
          // Validate required fields
          const resumeInput = document.getElementById('resume');
          if (!resumeInput.files.length) {
            alert('Please upload your resume.');
            return;
          }
          
          // Submit form
          applicationForm.submit();
        });
      }
      
      // File upload handling
      const resumeElement = document.getElementById('resume');
      if (resumeElement) {
        resumeElement.addEventListener('change', function(e) {
          const fileName = e.target.files[0] ? e.target.files[0].name : 'No file chosen';
          document.getElementById('resumeFileName').textContent = fileName;
        });
      }
      
      const attachmentsElement = document.getElementById('attachments');
      if (attachmentsElement) {
        attachmentsElement.addEventListener('change', function(e) {
          if (e.target.files.length > 0) {
            const fileNames = Array.from(e.target.files).map(file => file.name).join(', ');
            document.getElementById('attachmentsFileName').textContent = fileNames;
          } else {
            document.getElementById('attachmentsFileName').textContent = 'No files chosen';
          }
        });
      }
      
      // Drag and drop functionality for resume
      const resumeDropArea = document.getElementById('resumeDropArea');
      if (resumeDropArea) {
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
          resumeDropArea.addEventListener(eventName, preventDefaults, false);
        });
        
        function preventDefaults(e) {
          e.preventDefault();
          e.stopPropagation();
        }
        
        ['dragenter', 'dragover'].forEach(eventName => {
          resumeDropArea.addEventListener(eventName, highlight, false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
          resumeDropArea.addEventListener(eventName, unhighlight, false);
        });
        
        function highlight(e) {
          resumeDropArea.style.borderColor = '#007bff';
          resumeDropArea.style.backgroundColor = '#e9f4ff';
        }
        
        function unhighlight(e) {
          resumeDropArea.style.borderColor = '#ced4da';
          resumeDropArea.style.backgroundColor = '#f8f9fa';
        }
        
        resumeDropArea.addEventListener('drop', handleResumeDrop, false);
        
        function handleResumeDrop(e) {
          const dt = e.dataTransfer;
          const files = dt.files;
          if (files.length) {
            document.getElementById('resume').files = files;
            document.getElementById('resumeFileName').textContent = files[0].name;
          }
        }
      }
      
      // Drag and drop functionality for attachments
      const attachmentsDropArea = document.getElementById('attachmentsDropArea');
      if (attachmentsDropArea) {
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
          attachmentsDropArea.addEventListener(eventName, preventDefaults, false);
        });
        
        ['dragenter', 'dragover'].forEach(eventName => {
          attachmentsDropArea.addEventListener(eventName, highlightAttachments, false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
          attachmentsDropArea.addEventListener(eventName, unhighlightAttachments, false);
        });
        
        function highlightAttachments(e) {
          attachmentsDropArea.style.borderColor = '#007bff';
          attachmentsDropArea.style.backgroundColor = '#e9f4ff';
        }
        
        function unhighlightAttachments(e) {
          attachmentsDropArea.style.borderColor = '#ced4da';
          attachmentsDropArea.style.backgroundColor = '#f8f9fa';
        }
        
        attachmentsDropArea.addEventListener('drop', handleAttachmentsDrop, false);
        
        function handleAttachmentsDrop(e) {
          const dt = e.dataTransfer;
          const files = dt.files;
          if (files.length) {
            document.getElementById('attachments').files = files;
            const fileNames = Array.from(files).map(file => file.name).join(', ');
            document.getElementById('attachmentsFileName').textContent = fileNames;
          }
        }
      }
      
      // Make openApplicationModal globally available
      window.openApplicationModal = openApplicationModal;
      window.closeApplicationModal = closeApplicationModal;
    });

    /* ============================
       NOTIFICATION DROPDOWN
    ============================ */
    document.addEventListener("DOMContentLoaded", function() {
        const notifBell = document.getElementById("notifBell");
        const notifDropdown = document.getElementById("notifDropdown");
        
        if (notifBell && notifDropdown) {
            notifBell.addEventListener("click", function (event) {
                event.stopPropagation();
                notifDropdown.classList.toggle("show");
            });
            
            // Close dropdown when clicking outside
            document.addEventListener("click", function (event) {
                if (!notifDropdown.contains(event.target) && !notifBell.contains(event.target)) {
                    notifDropdown.classList.remove("show");
                }
            });
        }
    });
    
    // Example function to demonstrate error message usage
    function applyToOpportunity(opportunityId) {
        // Simulate an AJAX request to apply for an opportunity
        // In a real implementation, this would make an actual request
        
        // Show a loading message
        const loadingMsg = showInfoMessage('Processing', 'Applying to opportunity...', false);
        
        // Simulate API call delay
        setTimeout(function() {
            // Dismiss the loading message
            loadingMsg.querySelector('.alert-close').click();
            
            // Show success or error based on random chance (simulating real response)
            if (Math.random() > 0.3) {
                showSuccessMessage('Application Submitted', 'Your application has been successfully submitted!');
            } else {
                showErrorMessage('Application Failed', 'Unable to submit application. Please try again.');
            }
        }, 1500);
    }
    
    function closeApplicationSuccessModal() {
      const overlay = document.getElementById('applicationSuccessOverlay');
      if (overlay) {
        overlay.classList.remove('active');
      }
    }
  </script>
</body>
</html>