{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CampusLink â€“ Student Dashboard</title>
  <link rel="stylesheet" href="{% static 'Myapp/main.css' %}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="{% static 'Myapp/student_dashboard.css' %}?v=3.5">
  <link rel="stylesheet" href="{% static 'Myapp/main.css' %}">
  <!-- Include the error message component CSS -->
  <link rel="stylesheet" href="{% static 'Myapp/error_message.css' %}">
</head>
<body>
  <!-- Alert container for global error messages -->
  <div class="alert-container"></div>
  
  <header class="header">
    <div class="logo">
        <i class="fa-solid fa-graduation-cap"></i>
        <span>CampusLink</span>
    </div>

    <nav>
        <a href="#" class="active">Home</a>
        <a href="/my-applications/">My Applications</a>
        <a href="{% url 'profile' %}">Profile</a>
    </nav>

    <div class="search-profile">

        <!-- ðŸ”” NOTIFICATION BELL -->
        <div class="notification-wrapper">
            <div id="notifBell" class="notif-bell">
                <i class="fa-solid fa-bell"></i>
                {% if unread_count > 0 %}
                <span class="notif-badge">{{ unread_count }}</span>
                {% endif %}
            </div>

            <!-- ðŸ”½ DROPDOWN -->
            <div id="notifDropdown" class="notif-dropdown">
                <div class="notif-header">
                    Notifications
                </div>

                {% if notifications %}
                    {% for n in notifications %}
                        <div class="notif-item {% if not n.read %}notif-unread{% endif %}">
                            <div class="notif-title">{{ n.title }}</div>
                            <div class="notif-time">{{ n.timestamp|timesince }} ago</div>
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="notif-empty">
                        <i class="fa-regular fa-bell"></i>
                        <p>No notifications yet</p>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- PROFILE DROPDOWN -->
        <div class="profile-dropdown">
            <img src="{% if user.profile.profile_picture %}
                        {{ user.profile.profile_picture.url }}
                    {% else %}
                        /static/Myapp/default.png
                    {% endif %}"
                alt="Profile"
                class="avatar"
                id="profileAvatar">

    <div class="dropdown-menu" id="profileMenu">
        <div class="dropdown-header">Student</div>
        <a href="{% url 'profile' %}"><i class="fa-solid fa-user"></i> Profile</a>
        <a href="{% url 'logout' %}"><i class="fa-solid fa-right-from-bracket"></i> Log out</a>
    </div>
</div>

  </header>
  <main>
    <div class="dashboard-title">
      <h1>Discover Your Next <span style="color: #00c6ff;">Opportunity</span></h1>
      <p>Explore internships, research positions, and part-time jobs tailored for your academic journey.</p>
    </div>
    <section class="stats-row">
  <div class="stat-card">
    <span class="stat-num">{{ active_opportunities_count }}</span>
    <span class="stat-label">Active Opportunities</span>
  </div>

  <div class="stat-card">
    <span class="stat-num">{{ students_connected_count }}</span>
    <span class="stat-label">Students Connected</span>
  </div>

  <div class="stat-card">
    <span class="stat-num">1</span>
    <span class="stat-label">Applications Pending</span>
  </div>
</section>

    <section class="search-filter-row">
  <div class="search-controls-group">
    <div class="search-box">
      <i class="fa-solid fa-magnifying-glass"></i>
      <input type="text" placeholder="Search by title, organization, or skills..." />
    </div>
    
    <select class="filter-dropdown" id="sortDropdown">
      <option value="recent">Most Recent</option>
      <option value="deadline">Deadline Soonest</option>
      <option value="organization">Organization A-Z</option>
      <option value="title">Title A-Z</option>
    </select>

    <select class="filter-dropdown" id="deadlineFilter">
      <option value="">All Deadlines</option>
      <option value="today">Due Today</option>
      <option value="week">Due This Week</option>
      <option value="month">Due This Month</option>
      <option value="custom">Custom Range</option>
    </select>
    
    <div class="type-filter-inline">
      <span class="filter-label">Type:</span>
      <div class="type-filter-options-inline">
        <label class="type-checkbox-inline">
          <input type="checkbox" name="opportunityType" value="assistantship">
          <span class="checkmark-inline"></span>
          <span class="type-label-inline">Assistantship</span>
        </label>
        <label class="type-checkbox-inline">
          <input type="checkbox" name="opportunityType" value="volunteer">
          <span class="checkmark-inline"></span>
          <span class="type-label-inline">Volunteer</span>
        </label>
        <label class="type-checkbox-inline">
          <input type="checkbox" name="opportunityType" value="sports">
          <span class="checkmark-inline"></span>
          <span class="type-label-inline">Sports</span>
        </label>
        <label class="type-checkbox-inline">
          <input type="checkbox" name="opportunityType" value="leadership">
          <span class="checkmark-inline"></span>
          <span class="type-label-inline">Leadership</span>
        </label>
        <label class="type-checkbox-inline">
          <input type="checkbox" name="opportunityType" value="other">
          <span class="checkmark-inline"></span>
          <span class="type-label-inline">Other</span>
        </label>
      </div>
    </div>
  </div>

  <div class="filter-controls-group">
    <div class="custom-date-range" id="customDateRange" style="display: none;">
      <input type="date" id="startDate" class="date-input">
      <span>to</span>
      <input type="date" id="endDate" class="date-input">
      <button class="apply-custom-range">Apply</button>
    </div>
    <div class="search-results-info" id="searchResultsInfo">
      Showing <span id="resultsCount">0</span> results
    </div>
  </div>
</section>

    <!-- OPPORTUNITY GRID -->
<section class="opportunity-grid" id="opportunityGrid">
  {% for item in postings_list %}
  {% with posting=item.posting tags_list=item.tags_list %}
  <div class="opp-card" data-deadline="{{ posting.deadline|date:'Y-m-d' }}" data-type="other" data-posted="{{ posting.created_at|date:'Y-m-d' }}">
    <div class="opp-header">
      <h3>{{ posting.title }}</h3>
      <span class="opp-org">{{ posting.organization.profile.org_name|default:posting.organization.email }}</span>
    </div>
    <div class="opp-desc">{{ posting.description|truncatewords:20 }}</div>
    <div class="opp-tags">
      {% for tag in tags_list %}
        <span>{{ tag }}</span>
      {% endfor %}
    </div>
    <div class="opp-details">
      <span class="opp-type"><i class="fa-solid fa-briefcase"></i> Opportunity</span>
      <span class="opp-applicants">0 applicants</span>
      <span class="opp-deadline"><i class="fa-solid fa-calendar"></i> Due: {{ posting.deadline|date:"M d, Y" }}</span>
      <span class="type-badge other">Other</span>
    </div>
    <button class="apply-btn" onclick="applyToOpportunity({{ posting.id }})">Apply Now</button>
  </div>
  {% endwith %}
  {% empty %}
  <div class="no-opportunities-message" style="display: block; grid-column: 1 / -1;">
    <i class="fa-solid fa-inbox"></i>
    <h3>No Current Opportunities Available</h3>
    <p>We don't have any active opportunities posted by organizations at the moment. Please check back later as new opportunities are regularly added. Organizations must be verified to post opportunities, ensuring quality and legitimacy of all listings.</p>
    <div class="no-results-tip">
      <i class="fa-solid fa-lightbulb"></i>
      <span>Tip: Check back weekly for new opportunities tailored to your interests!</span>
    </div>
  </div>
  {% endfor %}
</section>

    <div class="no-results" id="noResults">
      <i class="fa-solid fa-search"></i>
      <h3>No opportunities found</h3>
      <p>Try adjusting your search terms or filters</p>
    </div>
  </main>
  <script src="{% static 'Myapp/student_dashboard.js' %}?v=1.8"></script>
  <!-- Include the error message component JavaScript -->
  <script src="{% static 'Myapp/error_message.js' %}"></script>
  <script>
    /* ============================
       NOTIFICATION DROPDOWN
    ============================ */
    document.addEventListener("DOMContentLoaded", function() {
        const notifBell = document.getElementById("notifBell");
        const notifDropdown = document.getElementById("notifDropdown");
        
        if (notifBell && notifDropdown) {
            notifBell.addEventListener("click", function (event) {
                event.stopPropagation();
                notifDropdown.classList.toggle("show");
            });
            
            // Close dropdown when clicking outside
            document.addEventListener("click", function (event) {
                if (!notifDropdown.contains(event.target) && !notifBell.contains(event.target)) {
                    notifDropdown.classList.remove("show");
                }
            });
        }
    });
    
    // Example function to demonstrate error message usage
    function applyToOpportunity(opportunityId) {
        // Simulate an AJAX request to apply for an opportunity
        // In a real implementation, this would make an actual request
        
        // Show a loading message
        const loadingMsg = showInfoMessage('Processing', 'Applying to opportunity...', false);
        
        // Simulate API call delay
        setTimeout(function() {
            // Dismiss the loading message
            loadingMsg.querySelector('.alert-close').click();
            
            // Show success or error based on random chance (simulating real response)
            if (Math.random() > 0.3) {
                showSuccessMessage('Application Submitted', 'Your application has been successfully submitted!');
            } else {
                showErrorMessage('Application Failed', 'Unable to submit application. Please try again.');
            }
        }, 1500);
    }
  </script>
</body>
</html>