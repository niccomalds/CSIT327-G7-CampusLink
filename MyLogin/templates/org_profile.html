{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Organization Profile â€“ CampusLink</title>

    <!-- Dashboard Header Styles -->
    <link rel="stylesheet" href="{% static 'Myapp/org_dashboard.css' %}">
    
    <!-- New Profile Page Styles -->
    <link rel="stylesheet" href="{% static 'Myapp/org_profile.css' %}?v=1.0">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>

<!-- ============================================================
     HEADER
============================================================ -->
<header class="header">

    <!-- LOGO -->
    <div class="logo">
        <i class="fa-solid fa-graduation-cap"></i>
        <span>CampusLink</span>
    </div>

    <!-- NAVIGATION -->
    <nav>
        <a href="{% url 'organization_dashboard' %}">Dashboard</a>
        <a href="{% url 'post_opportunity' %}">Post Opportunity</a>
        <a href="{% url 'manage_postings' %}">Applicants</a>
        <a href="{% url 'org_profile' %}" class="active">Org Profile</a>
    </nav>

    <!-- SEARCH + BELL + PROFILE -->
    <div class="search-profile">
        <input type="text" class="top-search" placeholder="Search opportunities...">

        <!-- ðŸ”” NOTIFICATION BELL -->
        <div class="notification-wrapper">
            <div id="notifBell" class="notif-bell">
                <i class="fa-solid fa-bell"></i>
                {% if unread_count > 0 %}
                    <span class="notif-badge">{{ unread_count }}</span>
                {% endif %}
            </div>

            <!-- ðŸ”½ DROP DOWN EXACTLY SAME AS STUDENT DASHBOARD -->
            <div id="notifDropdown" class="notif-dropdown">
                
                <div class="notif-header">Notifications</div>

                {% if notifications %}
                    {% for n in notifications %}
                        <div class="notif-item {% if not n.read %}notif-unread{% endif %}">
                            <div class="notif-title">{{ n.title }}</div>
                            <div class="notif-time">{{ n.timestamp|timesince }} ago</div>
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="notif-empty">
                        <i class="fa-regular fa-bell"></i>
                        <p>No notifications yet</p>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- ðŸ‘¤ PROFILE DROPDOWN -->
        <div class="profile-dropdown">
            <img src="{% if user.profile.profile_picture %}
                        {{ user.profile.profile_picture.url }}
                     {% else %}
                        /static/Myapp/default-avatar.png
                     {% endif %}"
                class="avatar"
                id="profileAvatar">

            <div class="dropdown-menu" id="profileMenu">
                <div class="dropdown-header">Organization</div>

                <a href="{% url 'org_profile' %}"><i class="fa-solid fa-user"></i> Profile</a>
                <a href="{% url 'org_settings' %}"><i class="fa-solid fa-gear"></i> Settings</a>
                <a href="{% url 'logout' %}"><i class="fa-solid fa-right-from-bracket"></i> Logout</a>
            </div>
        </div>
    </div>
</header>

<!-- ============================================================
     MAIN CONTENT
============================================================ -->
<div class="org-profile-container">

    <!-- PAGE INTRO -->
    <div class="page-header">
        <h1>Organization Profile</h1>
        <p>Manage your organization's branding, details, and online presence.</p>
    </div>
    
    <!-- General Error Container -->
    <div id="general-errors" class="error-container" style="display: none; background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; padding: 15px; margin-bottom: 20px; color: #ef4444;">
        <strong>âš  Please correct the following errors:</strong>
        <ul id="error-list" style="margin-top: 10px; margin-bottom: 0; padding-left: 20px;"></ul>
    </div>




    <!-- ============================================================
         ORGANIZATION OVERVIEW CARD
    ============================================================ -->
    <div class="card">
        <h2>Organization Overview</h2>

        <div class="logo-section">
            <div class="profile-photo-wrapper">
                {% if profile.org_logo %}
                    <img id="orgLogoPreview" src="{{ profile.org_logo.url }}" class="profile-photo">
                {% else %}
                    <img id="orgLogoPreview" src="{% static 'Myapp/default-logo.png' %}" class="profile-photo">
                {% endif %}

                <label id="photoEditIcon" class="edit-photo-icon hide-upload">
                    <input type="file" id="logoInput" accept="image/*" hidden>
                    <i class="fa-solid fa-pen"></i>
                </label>
            </div>
            <div class="org-header-info">
                <h2>{{ profile.org_name|default_if_none:'Organization Name' }} 
                    {% if profile.is_verified_organization %}<span class="verified-badge">Verified</span>{% endif %}
                </h2>
            </div>
        </div>

        <div class="form-grid">
            <div class="form-group">
                <label>Organization Name</label>
                <div class="org-name-container">
                    <input id="org_name" type="text" value="{{ profile.org_name|default_if_none:'' }}">
                </div>
                <span id="org_name-error" class="error-message"></span>
            </div>

            <div class="form-group">
                <label>Department</label>
                <input id="department" type="text" value="{{ profile.department|default_if_none:'' }}">
                <span id="department-error" class="error-message"></span>
            </div>

            <div class="form-group full">
                <label>Description</label>
                <textarea id="description">{{ profile.description|default_if_none:'' }}</textarea>
                <span id="description-error" class="error-message"></span>
            </div>

            <div class="form-group full">
                <label>Mission</label>
                <textarea id="mission">{{ profile.mission|default_if_none:'' }}</textarea>
                <span id="mission-error" class="error-message"></span>
            </div>
        </div>
    </div>




    <!-- ============================================================
         CONTACT INFORMATION
    ============================================================ -->
    <div class="card">
        <h2>Contact Information</h2>

        <div class="form-grid">
            <div class="form-group">
                <label>Email</label>
                <input id="contact_email" type="email" value="{{ profile.contact_email|default_if_none:'' }}">
                <span id="contact_email-error" class="error-message"></span>
            </div>

            <div class="form-group">
                <label>Phone Number</label>
                <input id="contact_phone" type="text" value="{{ profile.contact_phone|default_if_none:'' }}">
                <span id="contact_phone-error" class="error-message"></span>
            </div>

            <div class="form-group full">
                <label>Address</label>
                <input id="address" type="text" value="{{ profile.address|default_if_none:'' }}">
                <span id="address-error" class="error-message"></span>
            </div>

            <div class="form-group full">
                <label>Website</label>
                <input id="website" type="url" value="{{ profile.website|default_if_none:'' }}">
                <span id="website-error" class="error-message"></span>
            </div>
        </div>
    </div>




    <!-- ============================================================
         SOCIAL LINKS
    ============================================================ -->
    <div class="card">
        <h2>Social Links</h2>

        <div class="form-grid">
            <div class="form-group">
                <label>Facebook</label>
                <input id="social_facebook" type="url" value="{{ profile.social_facebook|default_if_none:'' }}">
                <span id="social_facebook-error" class="error-message"></span>
            </div>

            <div class="form-group">
                <label>Instagram</label>
                <input id="social_instagram" type="url" value="{{ profile.social_instagram|default_if_none:'' }}">
                <span id="social_instagram-error" class="error-message"></span>
            </div>

            <div class="form-group">
                <label>LinkedIn</label>
                <input id="social_linkedin" type="url" value="{{ profile.social_linkedin|default_if_none:'' }}">
                <span id="social_linkedin-error" class="error-message"></span>
            </div>
        </div>
    </div>




    <!-- ============================================================
         VISIBILITY SETTINGS
    ============================================================ -->
    <div class="card">
        <h2>Visibility</h2>

        <div class="form-group">
            <label>Profile Visibility</label>
            <select id="is_public">
                <option value="True" {% if profile.is_public %}selected{% endif %}>Public</option>
                <option value="False" {% if not profile.is_public %}selected{% endif %}>Applicants Only</option>
            </select>
        </div>
    </div>


    <!-- SAVE BUTTON -->
    <button id="editSaveBtn" class="save-btn">Edit Profile</button>

    <!-- Toast -->
    <div id="toast" class="toast">Profile updated successfully!</div>

</div>




<!-- ============================================================
     JAVASCRIPT (CLEAN + FINAL VERSION)
============================================================ -->
<script>

/* ----------------------- PROFILE MENU DROPDOWN ----------------------- */
const avatar = document.getElementById('profileAvatar');
const menu = document.getElementById('profileMenu');

avatar.onclick = (e) => {
    e.stopPropagation();
    menu.classList.toggle("show");
};

// Close dropdown when clicking outside
window.addEventListener("click", (e) => {
    if (!avatar.contains(e.target) && !menu.contains(e.target)) {
        menu.classList.remove("show");
    }
});


/* ----------------------- PHOTO PREVIEW ----------------------- */
document.getElementById("logoInput").addEventListener("change", function () {
    const file = this.files[0];
    if (file) {
        document.getElementById("orgLogoPreview").src = URL.createObjectURL(file);
    }
});


/* ----------------------- INITIAL VIEW MODE ----------------------- */
document.querySelectorAll(".form-grid input, .form-grid textarea, .form-grid select")
    .forEach(el => el.setAttribute("disabled", true));

document.getElementById("logoInput").setAttribute("disabled", true);
document.getElementById("photoEditIcon").classList.add("hide-upload");

let isEditing = false;


/* ----------------------- SAVE PROFILE ----------------------- */
async function saveProfile() {
    // Clear previous error messages
    clearErrors();

    const saveBtn = document.getElementById("editSaveBtn");
    saveBtn.classList.add("loading");

    let formData = new FormData();

    function getValue(id) {
        const v = document.getElementById(id).value;
        return v === "None" ? "" : v;
    }

    formData.append("org_name", getValue("org_name"));
    formData.append("department", getValue("department"));
    formData.append("description", getValue("description"));
    formData.append("mission", getValue("mission"));
    formData.append("contact_email", getValue("contact_email"));
    formData.append("contact_phone", getValue("contact_phone"));
    formData.append("address", getValue("address"));
    formData.append("website", getValue("website"));
    formData.append("social_facebook", getValue("social_facebook"));
    formData.append("social_instagram", getValue("social_instagram"));
    formData.append("social_linkedin", getValue("social_linkedin"));

    formData.append("is_public", document.getElementById("is_public").value);

    const logoFile = document.getElementById("logoInput").files[0];
    if (logoFile) formData.append("org_logo", logoFile);

    const res = await fetch("/organization/org-profile/save/", {
        method: "POST",
        headers: { "X-CSRFToken": getCookie("csrftoken") },
        body: formData
    });

    saveBtn.classList.remove("loading");

    // Handle response properly
    const data = await res.json();
    
    if (res.ok) {
        if (data.success) {
            showToast();

            if (data.updated?.profile_picture_url) {
                document.getElementById("profileAvatar").src = data.updated.profile_picture_url;
            }

            returnToViewMode();
        }
    } else {
        // Handle error responses (400 validation errors, 500 server errors, etc.)
        if (data.errors) {
            // Show validation error messages
            displayErrors(data.errors);
        } else {
            // Show general error message
            alert(data.error || 'Error saving profile');
        }
    }
}

/* ========================= ERROR HANDLING ========================= */
function clearErrors() {
    // Clear all field-specific error messages
    document.querySelectorAll('.error-message').forEach(el => {
        el.textContent = '';
        el.classList.remove('show');
    });
    
    // Remove error styling from inputs
    document.querySelectorAll('.form-group input, .form-group textarea').forEach(el => {
        el.classList.remove('input-error');
    });
    
    // Hide general error container
    const generalErrors = document.getElementById('general-errors');
    if (generalErrors) {
        generalErrors.style.display = 'none';
    }
}

function displayErrors(errors) {
    // Clear previous errors first
    clearErrors();
    
    // Display each error message
    let firstErrorField = null;
    for (const [field, message] of Object.entries(errors)) {
        const errorElement = document.getElementById(`${field}-error`);
        if (errorElement) {
            errorElement.textContent = message;
            errorElement.classList.add('show');
            
            // Add error styling to the input
            const inputElement = document.getElementById(field);
            if (inputElement) {
                inputElement.classList.add('input-error');
                
                // Keep track of the first error field for scrolling
                if (!firstErrorField) {
                    firstErrorField = inputElement;
                }
            }
        }
    }
    
    // Display general error summary
    const generalErrors = document.getElementById('general-errors');
    const errorList = document.getElementById('error-list');
    if (generalErrors && errorList && Object.keys(errors).length > 0) {
        // Clear previous error list
        errorList.innerHTML = '';
        
        // Add each error to the list
        for (const [field, message] of Object.entries(errors)) {
            const listItem = document.createElement('li');
            listItem.textContent = message;
            errorList.appendChild(listItem);
        }
        
        // Show the general error container
        generalErrors.style.display = 'block';
        
        // Scroll to the general error container
        generalErrors.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
    
    // Scroll to the first error field
    if (firstErrorField) {
        firstErrorField.scrollIntoView({ behavior: 'smooth', block: 'center' });
        firstErrorField.focus();
    }
}


/* ----------------------- RETURN TO VIEW MODE ----------------------- */
function returnToViewMode() {
    isEditing = false;
    document.getElementById("editSaveBtn").textContent = "Edit Profile";

    document.querySelectorAll(".form-grid input, .form-grid textarea, .form-grid select")
        .forEach(el => el.setAttribute("disabled", true));

    document.getElementById("logoInput").setAttribute("disabled", true);
    document.getElementById("photoEditIcon").classList.add("hide-upload");
}


/* ----------------------- ENTER EDIT MODE ----------------------- */
function enterEditMode() {
    isEditing = true;
    document.getElementById("editSaveBtn").textContent = "Save Changes";

    document.querySelectorAll(".form-grid input, .form-grid textarea, .form-grid select")
        .forEach(el => el.removeAttribute("disabled"));

    document.getElementById("logoInput").removeAttribute("disabled");
    document.getElementById("photoEditIcon").classList.remove("hide-upload");
}


/* ----------------------- EDIT BUTTON ----------------------- */
document.getElementById("editSaveBtn").addEventListener("click", () => {
    if (!isEditing) {
        enterEditMode();
    } else {
        saveProfile();
    }
});


/* ----------------------- TOAST ----------------------- */
function showToast() {
    const t = document.getElementById("toast");
    t.classList.add("show");
    setTimeout(() => t.classList.remove("show"), 2000);
}


/* ----------------------- CSRF ----------------------- */
function getCookie(name) {
    const cookies = document.cookie.split(";");
    for (let c of cookies) {
        const cookie = c.trim();
        if (cookie.startsWith(name + "=")) {
            return cookie.substring(name.length + 1);
        }
    }
    return null;
}


/* =====================================================
   ðŸ”” NOTIFICATION DROPDOWN â€” FINAL WORKING VERSION
===================================================== */
const notifBell = document.getElementById("notifBell");
const notifDropdown = document.getElementById("notifDropdown");

notifBell.addEventListener("click", function (event) {
    event.stopPropagation();
    notifDropdown.classList.toggle("show");
});

document.addEventListener("click", function (event) {
    if (!notifDropdown.contains(event.target) && !notifBell.contains(event.target)) {
        notifDropdown.classList.remove("show");
    }
});


</script>

</body>
</html>
