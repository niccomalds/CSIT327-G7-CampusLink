{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Organization Profile Wizard – CampusLink</title>

  <!-- Dashboard theme -->
  <link rel="stylesheet" href="{% static 'Myapp/org_dashboard.css' %}">
  <link rel="stylesheet" href="{% static 'Myapp/org_profile.css' %}">

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- CropperJS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css" />
</head>

<body>

<!-- ========================= HEADER ========================= -->
<header class="header">
    <div class="logo">
      <i class="fa-solid fa-graduation-cap"></i>
      <span>CampusLink</span>
    </div>

    <nav>
      <a href="{% url 'organization_dashboard' %}">Dashboard</a>
      <a href="{% url 'post_opportunity' %}">Post Opportunity</a>
      <a href="{% url 'manage_postings' %}">Applicants</a>
      <a href="{% url 'org_profile' %}" class="active">Org Profile</a>
    </nav>

    <div class="search-profile">
        <input type="text" class="top-search" placeholder="Search opportunities...">

        <div class="profile-dropdown">
            <img src="{% if user.profile.profile_picture %}{{ user.profile.profile_picture.url }}{% else %}/static/Myapp/default-avatar.png{% endif %}"
                 class="avatar" id="profileAvatar">

            <div class="dropdown-menu" id="orgDropdownMenu">
                <div class="dropdown-header">Organization</div>
                <a href="{% url 'org_profile' %}"><i class="fa-solid fa-user"></i> Profile</a>
                <a href="{% url 'org_settings' %}"><i class="fa-solid fa-gear"></i> Settings</a>
                <a href="{% url 'logout' %}"><i class="fa-solid fa-right-from-bracket"></i> Logout</a>
            </div>
        </div>
    </div>
</header>


<!-- ========================= MAIN WIZARD ========================= -->
<main class="profile-container">

  <!-- PROGRESS BAR -->
  <div class="wizard-progress">
      <div class="progress-bar">
          <div class="progress-fill"></div>
      </div>

      <div class="step active">Overview</div>
      <div class="step">Branding</div>
      <div class="step">Contacts</div>
      <div class="step">Socials</div>
      <div class="step">Visibility</div>
  </div>

  <form id="wizardForm" method="POST" enctype="multipart/form-data">
      {% csrf_token %}

      <!-- ============================================================
           STEP 1 — OVERVIEW
      ============================================================ -->
      <div class="wizard-panel active">
        <h2 class="wizard-title">Organization Overview</h2>

        <div class="form-group">
          <label>Organization Name</label>
          <input name="org_name" type="text" value="{{ profile.org_name }}">
        </div>

        <div class="form-group">
          <label>Description</label>
          <textarea name="description" rows="3">{{ profile.description }}</textarea>
        </div>

        <div class="form-group">
          <label>Mission</label>
          <textarea name="mission" rows="2">{{ profile.mission }}</textarea>
        </div>

        <div class="form-group">
          <label>Department</label>
          <input name="department" type="text" value="{{ profile.department }}">
        </div>

        <div class="form-group">
          <label>Website</label>
          <input name="website" type="url" placeholder="https://example.com" value="{{ profile.website }}">
        </div>

        <button type="button" class="next-btn save-btn">Next</button>
      </div>

      <!-- ============================================================
           STEP 2 — BRANDING
      ============================================================ -->
      <div class="wizard-panel">
        <h2 class="wizard-title">Branding</h2>

        <div class="logo-section">
          <img id="logoPreview"
               src="{% if profile.org_logo %}{{ profile.org_logo.url }}{% else %}/static/Myapp/default-logo.png{% endif %}"
               class="org-logo">

          <input id="logoInput" type="file" accept="image/*">
        </div>

        <button type="button" class="back-btn save-btn">Back</button>
        <button type="button" class="next-btn save-btn">Next</button>
      </div>

      <!-- ============================================================
           STEP 3 — CONTACTS
      ============================================================ -->
      <div class="wizard-panel">
        <h2 class="wizard-title">Contact Information</h2>

        <div class="form-group">
          <label>Email</label>
          <input name="contact_email" type="email" value="{{ profile.contact_email }}">
        </div>

        <div class="form-group">
          <label>Phone</label>
          <input name="contact_phone" type="text" value="{{ profile.contact_phone }}">
        </div>

        <div class="form-group">
          <label>Address</label>
          <input name="address" type="text" value="{{ profile.address }}">
        </div>

        <button type="button" class="back-btn save-btn">Back</button>
        <button type="button" class="next-btn save-btn">Next</button>
      </div>

      <!-- ============================================================
           STEP 4 — SOCIALS
      ============================================================ -->
      <div class="wizard-panel">
        <h2 class="wizard-title">Social Media</h2>

        <div class="form-group">
          <label>Facebook</label>
          <input name="social_facebook" type="url" value="{{ profile.social_facebook }}">
        </div>

        <div class="form-group">
          <label>Instagram</label>
          <input name="social_instagram" type="url" value="{{ profile.social_instagram }}">
        </div>

        <div class="form-group">
          <label>LinkedIn</label>
          <input name="social_linkedin" type="url" value="{{ profile.social_linkedin }}">
        </div>

        <button type="button" class="back-btn save-btn">Back</button>
        <button type="button" class="next-btn save-btn">Next</button>
      </div>

      <!-- ============================================================
           STEP 5 — VISIBILITY
      ============================================================ -->
      <div class="wizard-panel">
        <h2 class="wizard-title">Profile Visibility</h2>

        <div class="form-group">
          <label>Who can see your profile?</label>
          <select name="is_public">
            <option value="True" {% if profile.is_public %}selected{% endif %}>Public</option>
            <option value="False" {% if not profile.is_public %}selected{% endif %}>Applicants Only</option>
          </select>
        </div>

        <button type="button" class="back-btn save-btn">Back</button>
        <button type="button" id="finalSaveBtn" class="save-btn">Save Profile</button>
      </div>

  </form>
</main>


<!-- ========================= CROPPER MODAL ========================= -->
<div id="cropModal" class="crop-modal">
    <div class="crop-modal-content">
        <div class="crop-header">
            <h3>Crop Logo</h3>
            <span class="close-cropper">&times;</span>
        </div>

        <div class="crop-body">
            <img id="cropperImage">
        </div>

        <button id="applyCropBtn" class="apply-crop-btn">Apply Crop</button>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>

<script>
/* ============================================================
   WIZARD NAVIGATION
============================================================ */
let currentStep = 0;
const steps = document.querySelectorAll(".wizard-panel");
const indicators = document.querySelectorAll(".step");
const progress = document.querySelector(".progress-fill");

function showStep(i){
    steps.forEach((s,idx)=> s.classList.toggle("active", idx===i));
    indicators.forEach((s,idx)=> s.classList.toggle("active", idx===i));
    progress.style.width = (i/(steps.length-1))*100 + "%";
    currentStep = i;
}

document.querySelectorAll(".next-btn").forEach(btn =>
    btn.onclick = () => showStep(currentStep + 1)
);

document.querySelectorAll(".back-btn").forEach(btn =>
    btn.onclick = () => showStep(currentStep - 1)
);

indicators.forEach((indicator, index) =>
    indicator.onclick = () => showStep(index)
);

showStep(0);


/* ============================================================
   CROPPER HANDLING
============================================================ */
let cropper = null;
const modal = document.getElementById("cropModal");
const cropImg = document.getElementById("cropperImage");
const preview = document.getElementById("logoPreview");
const input = document.getElementById("logoInput");

input.addEventListener("change", e => {
    const file = e.target.files[0];
    if (!file) return;

    cropImg.src = URL.createObjectURL(file);
    modal.style.display = "flex";

    setTimeout(() => {
        if (cropper) cropper.destroy();
        cropper = new Cropper(cropImg, { aspectRatio: 1, viewMode: 1 });
    }, 200);
});

document.querySelector(".close-cropper").onclick =
    () => modal.style.display = "none";

document.getElementById("applyCropBtn").onclick = () => {
    const canvas = cropper.getCroppedCanvas({ width: 300 });
    canvas.toBlob(blob => {
        preview.src = URL.createObjectURL(blob);
        window.croppedLogo = blob;
        modal.style.display = "none";
    });
};


/* ============================================================
   SAVE PROFILE (AJAX)
============================================================ */
document.getElementById("finalSaveBtn").onclick = async () => {
    const form = document.getElementById("wizardForm");
    const fd = new FormData(form);

    // Add cropped logo if exists
    if (window.croppedLogo)
        fd.append("org_logo", window.croppedLogo, "logo.png");

    const res = await fetch("{% url 'save_org_profile' %}", {
        method: "POST",
        body: fd
    });

    const data = await res.json();
    if (data.success) {
        alert("Profile updated successfully!");
        location.reload();
    } else {
        alert("Error: " + (data.error || "Something went wrong"));
    }
};
</script>
</body>
</html>
